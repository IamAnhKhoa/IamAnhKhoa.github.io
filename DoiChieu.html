<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard BHYT To√†n di·ªán</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Global Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
            line-height: 1.6; 
        }
        
        .container { 
            max-width: 1800px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); 
            overflow: hidden; 
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0.5;
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        /* Tab Navigation */
        .tab-nav { 
            display: flex; 
            background: #f8f9fa; 
            border-bottom: 3px solid #dee2e6; 
        }
        
        .tab-button { 
            flex: 1; 
            padding: 20px 30px; 
            border: none; 
            background: transparent; 
            font-size: 1.1em; 
            font-weight: 600; 
            color: #6c757d; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            position: relative; 
        }
        
        .tab-button:hover { 
            background: rgba(102, 126, 234, 0.1); 
            color: #667eea; 
            transform: translateY(-2px);
        }
        
        .tab-button.active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .tab-content { 
            display: none; 
            padding: 30px; 
            animation: fadeIn 0.5s ease; 
        }
        
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            height: 400px;
        }
        
        /* Advanced Filters */
        .advanced-filters {
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .filter-header h3 {
            color: #2c3e50;
            font-size: 1.4em;
        }
        
        .filter-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .filter-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }
        
        .filter-input, .filter-select {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }
        
        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .date-range-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .filter-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* File Upload Area */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px 30px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #e6f3ff 0%, #d4edda 100%);
        }
        
        .upload-area.drag-over {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            transform: scale(1.02);
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 20px;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }
        
        .file-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* Results Table */
        .results-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 30px;
        }
        
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }
        
        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.3s ease;
            vertical-align: top;
        }
        
        .results-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .results-table .error-detail {
            margin-bottom: 5px;
        }
        .comparator-details ul {
            padding-left: 20px;
            margin: 0;
            font-size: 0.9em;
        }
        .comparator-details li {
            color: #c53030;
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 2px;
        }
        
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-mismatch { background: #f8d7da; color: #721c24; }
        .status-match { background: #d4edda; color: #155724; }
        .status-xml-only { background: #d1ecf1; color: #0c5460; }
        .status-excel-only { background: #e2e3e5; color: #383d41; }
        
        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }
        
        .loading.show { display: block; }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-nav {
                flex-direction: column;
            }
            
            .filter-actions {
                flex-direction: column;
            }
        }
        
        /* Pagination */
        .pagination {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .pagination button {
            padding: 8px 15px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            margin: 0 15px;
            font-weight: 600;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üè• Dashboard BHYT To√†n di·ªán</h1>
            <p>H·ªá th·ªëng qu·∫£n l√Ω v√† ph√¢n t√≠ch d·ªØ li·ªáu BHYT v·ªõi dashboard th√¥ng minh</p>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" onclick="openTab(event, 'dashboardTab')">üìä Dashboard</button>
            <button class="tab-button" onclick="openTab(event, 'validatorTab')">üìã Ki·ªÉm tra XML</button>
            <button class="tab-button" onclick="openTab(event, 'comparatorTab')">üîÑ ƒê·ªëi chi·∫øu</button>
            <button class="tab-button" onclick="openTab(event, 'reportsTab')">üìà B√°o c√°o</button>
        </nav>

        <div id="dashboardTab" class="tab-content active">
            <div class="stats-overview" id="dashboardStats">
                <div class="stat-card">
                    <h3 id="totalFiles">0</h3>
                    <p>T·ªïng file ƒë√£ x·ª≠ l√Ω</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalRecords">0</h3>
                    <p>T·ªïng h·ªì s∆°</p>
                </div>
                <div class="stat-card">
                    <h3 id="errorRate">0%</h3>
                    <p>T·ª∑ l·ªá l·ªói</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalAmount">0</h3>
                    <p>T·ªïng chi ph√≠ BHYT TT</p>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container">
                    <canvas id="errorTypesChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="amountChart"></canvas>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container">
                    <canvas id="topDrugsChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="topServicesChart"></canvas>
                </div>
            </div>
        </div>

        <div id="validatorTab" class="tab-content">
            <div class="upload-area" id="validatorUploadArea">
                <h2>üìÅ T·∫£i l√™n file XML BHYT</h2>
                <p>K√©o th·∫£ file XML v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn file</p>
                <div class="file-input-wrapper">
                    <input type="file" class="file-input" id="validatorFileInput" accept=".xml">
                    <button class="file-button">Ch·ªçn file XML</button>
                </div>
                <div id="validatorFileInfo" style="display:none; margin-top: 15px; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;"></div>
                <button class="btn btn-primary" id="validatorProcessButton" style="margin-top: 20px;" disabled>üöÄ B·∫Øt ƒë·∫ßu ki·ªÉm tra</button>
            </div>

            <div class="loading" id="validatorLoading">
                <div class="spinner"></div>
                <p>ƒêang x·ª≠ l√Ω file XML...</p>
            </div>

            <div class="advanced-filters" id="validatorFilters" style="display: none;">
                <div class="filter-header">
                    <h3>üîç B·ªô l·ªçc n√¢ng cao</h3>
                    <button class="filter-toggle" onclick="toggleFilterVisibility('validatorFilters')">Thu g·ªçn</button>
                </div>
                
                <div class="filter-content">
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label>Lo·∫°i l·ªói:</label>
                            <select class="filter-select" id="errorTypeFilter">
                                <option value="">T·∫•t c·∫£ lo·∫°i l·ªói</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>M·ª©c ƒë·ªô:</label>
                            <select class="filter-select" id="severityFilter">
                                <option value="">T·∫•t c·∫£ m·ª©c ƒë·ªô</option>
                                <option value="critical">üî¥ Nghi√™m tr·ªçng</option>
                                <option value="warning">üü° C·∫£nh b√°o</option>
                                <option value="success">üü¢ H·ª£p l·ªá</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>T√¨m ki·∫øm:</label>
                            <input type="text" class="filter-input" id="searchBox" placeholder="T√™n, m√£ LK, m√£ BN...">
                        </div>
                        
                        <div class="filter-group">
                            <label>Kho·∫£ng th·ªùi gian v√†o vi·ªán:</label>
                            <div class="date-range-group">
                                <input type="date" class="filter-input" id="dateFromFilter">
                                <input type="date" class="filter-input" id="dateToFilter">
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label>Kho·∫£ng chi ph√≠ BHYT TT (VNƒê):</label>
                            <div class="date-range-group">
                                <input type="number" class="filter-input" id="amountFromFilter" placeholder="T·ª´">
                                <input type="number" class="filter-input" id="amountToFilter" placeholder="ƒê·∫øn">
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label>Gi·ªõi t√≠nh:</label>
                            <select class="filter-select" id="genderFilter">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="1">Nam</option>
                                <option value="2">N·ªØ</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label>B·ªánh nh√¢n c√πng chi tr·∫£ (CCT):</label>
                            <select class="filter-select" id="bncctFilter">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="yes">C√≥ CCT (> 0)</option>
                                <option value="no">Kh√¥ng c√≥ CCT (= 0)</option>
                            </select>
                        </div>

                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="applyFilters()">üîç √Åp d·ª•ng l·ªçc</button>
                        <button class="btn btn-warning" onclick="clearFilters()">üîÑ X√≥a b·ªô l·ªçc</button>
                        <button class="btn btn-success" onclick="exportToExcel(false)">üìä Xu·∫•t Excel</button>
                        <button class="btn btn-danger" onclick="exportToExcel(true)">‚ö†Ô∏è Ch·ªâ xu·∫•t l·ªói</button>
                    </div>
                </div>
            </div>

            <div class="results-container" id="validatorResults" style="display: none;">
                <div class="table-header">
                    <h3>üìã K·∫øt qu·∫£ ki·ªÉm tra</h3>
                    <div id="resultsInfo" style="font-size: 0.9em; opacity: 0.9;"></div>
                </div>
                
                <div style="overflow-x: auto; max-height: 600px;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Th√¥ng tin BN</th>
                                <th>Th·ªùi gian ƒëi·ªÅu tr·ªã</th>
                                <th>Chi ph√≠ BHYT TT</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Chi ti·∫øt l·ªói</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="paginationContainer">
                </div>
            </div>
        </div>

        <div id="comparatorTab" class="tab-content">
            <div class="upload-area">
                <h2>üîÑ ƒê·ªëi chi·∫øu XML & Excel/CSV</h2>
                <p>T·∫£i l√™n c·∫£ file XML v√† file ƒë·ªëi chi·∫øu (Excel ho·∫∑c CSV)</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <div>
                        <h3>üìÑ File XML BHYT</h3>
                        <div class="file-input-wrapper" style="width: 100%;">
                            <input type="file" class="file-input" id="comparatorXmlInput" accept=".xml">
                            <button class="file-button" style="width: 100%;">Ch·ªçn file XML</button>
                        </div>
                        <div id="xmlStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
                    </div>
                    
                    <div>
                        <h3>üìä File ƒë·ªëi chi·∫øu (Excel/CSV)</h3>
                        <div class="file-input-wrapper" style="width: 100%;">
                            <input type="file" class="file-input" id="comparatorExcelInput" accept=".xlsx,.xls,.csv">
                            <button class="file-button" style="width: 100%;">Ch·ªçn file Excel/CSV</button>
                        </div>
                        <div id="excelStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" id="compareButton" disabled>‚ö° B·∫Øt ƒë·∫ßu ƒë·ªëi chi·∫øu</button>
                </div>
            </div>

            <div class="loading" id="comparatorLoading">
                <div class="spinner"></div>
                <p>ƒêang ƒë·ªëi chi·∫øu d·ªØ li·ªáu...</p>
            </div>

            <div id="comparatorResults" style="display: none;">
                <div class="advanced-filters">
                    <div class="filter-header">
                        <h3>üîç L·ªçc k·∫øt qu·∫£ ƒë·ªëi chi·∫øu</h3>
                    </div>
                    
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label>Tr·∫°ng th√°i:</label>
                            <select class="filter-select" id="statusFilter" onchange="applyComparatorFilters()">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="match">‚úÖ Kh·ªõp</option>
                                <option value="mismatch">‚ùå Kh√¥ng kh·ªõp</option>
                                <option value="xml-only">üìÑ Ch·ªâ c√≥ trong XML</option>
                                <option value="excel-only">üìä Ch·ªâ c√≥ trong file ƒë·ªëi chi·∫øu</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>T√¨m m√£ LK:</label>
                            <input type="text" class="filter-input" id="maLkSearch" placeholder="Nh·∫≠p m√£ LK..." oninput="applyComparatorFilters()">
                        </div>
                        
                        <div class="filter-group">
                            <label>T√¨m t√™n BN:</label>
                            <input type="text" class="filter-input" id="patientSearch" placeholder="Nh·∫≠p t√™n b·ªánh nh√¢n..." oninput="applyComparatorFilters()">
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn btn-warning" onclick="clearComparatorFilters()">üîÑ X√≥a l·ªçc</button>
                        <button class="btn btn-success" onclick="exportComparatorResults()">üìä Xu·∫•t Excel</button>
                    </div>
                </div>
                
                <div class="results-container">
                    <div class="table-header">
                        <h3>üìã K·∫øt qu·∫£ ƒë·ªëi chi·∫øu</h3>
                        <div id="comparatorResultsInfo"></div>
                    </div>
                    
                    <div style="overflow-x: auto; max-height: 600px;" id="comparatorResultsTableWrapper">
                        </div>
                </div>
            </div>
        </div>

        <div id="reportsTab" class="tab-content">
             <div class="advanced-filters">
                <div class="filter-header">
                    <h3>üìä T√πy ch·ªçn b√°o c√°o</h3>
                </div>
                
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Lo·∫°i b√°o c√°o:</label>
                        <select class="filter-select" id="reportType">
                            <option value="error-summary" selected>T√≥m t·∫Øt l·ªói</option>
                            <option value="time-analysis">Ph√¢n t√≠ch theo th·ªùi gian</option>
                            <option value="cost-analysis">Ph√¢n t√≠ch chi ph√≠</option>
                            <option value="department-analysis">Ph√¢n t√≠ch theo khoa</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Kho·∫£ng th·ªùi gian (Ng√†y v√†o):</label>
                        <div class="date-range-group">
                            <input type="date" class="filter-input" id="reportDateFrom">
                            <input type="date" class="filter-input" id="reportDateTo">
                        </div>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="generateReport()">üìà T·∫°o b√°o c√°o</button>
                    <button class="btn btn-success" onclick="exportReport()">üìä Xu·∫•t b√°o c√°o</button>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container" id="reportChart1Container">
                     <canvas id="reportChart1"></canvas>
                </div>
                <div class="chart-container" id="reportChart2Container">
                    <canvas id="reportChart2"></canvas>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // ============================= GLOBAL VARIABLES & UTILITIES =============================
        let globalData = {
            allRecords: [],
            allDrugs: [],
            allServices: [],
            filteredRecords: [],
            currentPage: 1,
            pageSize: 50,
            xmlDataContent: null,
            xmlFile: null,
            excelFile: null,
            xmlRecords: new Map(),
            excelRecords: new Map(),
            comparisonResults: [],
            filteredComparisonResults: [],
            charts: {}
        };

        const ERROR_TYPES = {
            'NGAY_YL_THUOC_SAU_RA_VIEN': 'Thu·ªëc - YL sau ra vi·ªán',
            'NGAY_YL_DVKT_SAU_RA_VIEN': 'DVKT - YL sau ra vi·ªán',
            'NGAY_YL_THUOC_NGOAI_KHOANG': 'Thu·ªëc - YL ngo√†i kho·∫£ng',
            'NGAY_YL_DVKT_NGOAI_KHOANG': 'DVKT - YL ngo√†i kho·∫£ng',
            'NGAY_VAO_SAU_NGAY_RA': 'Ng√†y v√†o sau ng√†y ra',
            'THE_BHYT_HET_HAN': 'Th·∫ª BHYT h·∫øt h·∫°n',
        };

        // Utility functions
        const formatDateTimeForDisplay = (dateString) => {
            if (!dateString) return '';
            const s = String(dateString).trim();
            if (s.length >= 8) {
                const year = s.substring(0, 4);
                const month = s.substring(4, 6);
                const day = s.substring(6, 8);
                let formatted = `${day}/${month}/${year}`;
                if (s.length >= 12) {
                    const hour = s.substring(8, 10);
                    const minute = s.substring(10, 12);
                    formatted += ` ${hour}:${minute}`;
                }
                return formatted;
            }
            return dateString; // Fallback
        };
        
        const formatCurrency = (amount) => {
            const num = Number(amount);
            if (isNaN(num)) return 'N/A';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(num);
        };
        
        const showLoading = (id) => document.getElementById(id).classList.add('show');
        const hideLoading = (id) => document.getElementById(id).classList.remove('show');

        // ============================= TAB MANAGEMENT =============================
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            
            if (tabName === 'dashboardTab' && globalData.allRecords.length > 0) {
                updateDashboard();
            } else if (tabName === 'reportsTab' && globalData.allRecords.length > 0) {
                 generateReport();
            }
        }

        function toggleFilterVisibility(filterContainerId) {
            const filterContent = document.querySelector(`#${filterContainerId} .filter-content`);
            const toggleButton = document.querySelector(`#${filterContainerId} .filter-toggle`);
            if (filterContent.style.display === 'none' || !filterContent.style.display) {
                filterContent.style.display = 'grid';
                 if(document.querySelector(`#${filterContainerId} .filter-actions`)) {
                    document.querySelector(`#${filterContainerId} .filter-actions`).style.display = 'flex';
                }
                toggleButton.textContent = 'Thu g·ªçn';
            } else {
                filterContent.style.display = 'none';
                 if(document.querySelector(`#${filterContainerId} .filter-actions`)) {
                    document.querySelector(`#${filterContainerId} .filter-actions`).style.display = 'none';
                }
                toggleButton.textContent = 'M·ªü r·ªông';
            }
        }

        // ============================= DASHBOARD & REPORTS FUNCTIONALITY =============================
        function updateDashboard() {
            if (globalData.allRecords.length === 0) return;

            const stats = calculateGlobalStats(globalData.allRecords);
            
            document.getElementById('totalFiles').textContent = globalData.xmlDataContent ? 1 : 0;
            document.getElementById('totalRecords').textContent = stats.totalRecords.toLocaleString('vi-VN');
            document.getElementById('errorRate').textContent = stats.errorRate.toFixed(2) + '%';
            document.getElementById('totalAmount').textContent = formatCurrency(stats.totalAmount); // totalAmount is now T_BHTT
            
            updateChart('errorTypesChart', 'doughnut', {
                labels: Object.keys(stats.errorTypes).map(key => ERROR_TYPES[key] || key),
                datasets: [{ data: Object.values(stats.errorTypes), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'] }]
            }, 'Ph√¢n b·ªë lo·∫°i l·ªói');

            const sortedTimeline = Object.entries(stats.timeline).sort(([a], [b]) => a.localeCompare(b));
            updateChart('timelineChart', 'line', {
                labels: sortedTimeline.map(([month]) => `${month.substring(4,6)}/${month.substring(0,4)}`),
                datasets: [{ label: 'S·ªë h·ªì s∆°', data: sortedTimeline.map(([, count]) => count), borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', fill: true, tension: 0.4 }]
            }, 'Xu h∆∞·ªõng theo th·ªùi gian');

            const sortedDepartments = Object.entries(stats.departments).sort(([,a], [,b]) => b - a).slice(0, 10);
            updateChart('departmentChart', 'bar', {
                labels: sortedDepartments.map(([name]) => name || 'Kh√¥ng x√°c ƒë·ªãnh'),
                datasets: [{ label: 'S·ªë h·ªì s∆°', data: sortedDepartments.map(([, count]) => count), backgroundColor: 'rgba(75, 192, 192, 0.8)' }]
            }, 'Top 10 Khoa c√≥ nhi·ªÅu h·ªì s∆° nh·∫•t');
            
            updateChart('amountChart', 'bar', {
                labels: Object.keys(stats.amounts),
                datasets: [{ label: 'S·ªë h·ªì s∆°', data: Object.values(stats.amounts), backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545', '#6f42c1']}]
            }, 'Ph√¢n b·ªë chi ph√≠ BHYT TT');

            // Render new dashboards
            renderDrugAndServiceDashboard();
        }
        
        function renderDrugAndServiceDashboard() {
            // Process drugs
            const drugCosts = {};
            globalData.allDrugs.forEach(drug => {
                const key = `${drug.ten_thuoc} (${drug.ma_thuoc})`;
                drugCosts[key] = (drugCosts[key] || 0) + drug.thanh_tien_bh;
            });
            const topDrugs = Object.entries(drugCosts).sort(([,a],[,b]) => b-a).slice(0, 10);
            updateChart('topDrugsChart', 'bar', {
                labels: topDrugs.map(([name]) => name),
                datasets: [{ label: 'T·ªïng chi ph√≠ BHYT', data: topDrugs.map(([,cost])=>cost), backgroundColor: 'rgba(255, 99, 132, 0.8)' }]
            }, 'Top 10 Thu·ªëc c√≥ chi ph√≠ BHYT cao nh·∫•t');

            // Process services
            const serviceCosts = {};
            globalData.allServices.forEach(service => {
                const key = `${service.ten_dich_vu} (${service.ma_dich_vu})`;
                serviceCosts[key] = (serviceCosts[key] || 0) + service.thanh_tien_bh;
            });
            const topServices = Object.entries(serviceCosts).sort(([,a],[,b]) => b-a).slice(0, 10);
            updateChart('topServicesChart', 'bar', {
                labels: topServices.map(([name]) => name),
                datasets: [{ label: 'T·ªïng chi ph√≠ BHYT', data: topServices.map(([,cost])=>cost), backgroundColor: 'rgba(54, 162, 235, 0.8)' }]
            }, 'Top 10 DVKT c√≥ chi ph√≠ BHYT cao nh·∫•t');
        }

        function calculateGlobalStats(records) {
            const totalRecords = records.length;
            if (totalRecords === 0) {
                 return { totalRecords: 0, errorRecordsCount: 0, errorRate: 0, totalAmount: 0, errorTypes: {}, timeline: {}, departments: {}, amounts: {} };
            }

            const errorRecordsCount = records.filter(r => r.errors && r.errors.length > 0).length;
            const errorRate = (errorRecordsCount / totalRecords) * 100;
            
            const stats = {
                totalRecords,
                errorRecordsCount,
                errorRate,
                totalAmount: 0,
                errorTypes: {},
                timeline: {},
                departments: {},
                amounts: { '< 1tr': 0, '1-5tr': 0, '5-10tr': 0, '10-50tr': 0, '> 50tr': 0 }
            };

            records.forEach(r => {
                stats.totalAmount += r.t_bhtt || 0;
                if (r.errors) r.errors.forEach(err => { stats.errorTypes[err.type] = (stats.errorTypes[err.type] || 0) + 1; });
                if (r.ngayVao) {
                    const month = String(r.ngayVao).substring(0, 6);
                    stats.timeline[month] = (stats.timeline[month] || 0) + 1;
                }
                if(r.maKhoa) stats.departments[r.maKhoa] = (stats.departments[r.maKhoa] || 0) + 1;

                const cost = r.t_bhtt || 0; // The amount paid by insurance
                if (cost < 1000000) stats.amounts['< 1tr']++;
                else if (cost <= 5000000) stats.amounts['1-5tr']++;
                else if (cost <= 10000000) stats.amounts['5-10tr']++;
                else if (cost <= 50000000) stats.amounts['10-50tr']++;
                else stats.amounts['> 50tr']++;
            });
            
            return stats;
        }

        function updateChart(canvasId, type, data, titleText) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (globalData.charts[canvasId]) globalData.charts[canvasId].destroy();
            
            globalData.charts[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: type === 'bar' && data.labels.length > 5 ? 'y' : 'x', // Use horizontal bar for long labels
                    plugins: {
                        title: { display: true, text: titleText, font: {size: 16} },
                        legend: { display: (data.datasets[0].label && type !== 'doughnut' && type !== 'pie') }
                    },
                    scales: (type === 'bar' || type === 'line') ? { y: { beginAtZero: true } } : {}
                }
            });
        }
        
        // ============================= VALIDATOR FUNCTIONALITY =============================
        function initializeValidator() {
            const fileInput = document.getElementById('validatorFileInput');
            const uploadArea = document.getElementById('validatorUploadArea');
            
            fileInput.addEventListener('change', (e) => handleFileUpload(e, 'validator'));
            document.getElementById('validatorProcessButton').addEventListener('click', processXmlFile);
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (eventName === 'dragover') uploadArea.classList.add('drag-over');
                    if (eventName === 'dragleave' || eventName === 'drop') uploadArea.classList.remove('drag-over');
                    if (eventName === 'drop' && e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileUpload({ target: { files: e.dataTransfer.files } }, 'validator');
                    }
                });
            });
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            if (type === 'validator' || type === 'xml') {
                if (!file.name.toLowerCase().endsWith('.xml')) {
                    alert('Vui l√≤ng ch·ªçn file c√≥ ƒë·ªãnh d·∫°ng .xml!');
                    event.target.value = '';
                    return;
                }
            }

            const fileInfoDiv = document.getElementById(type === 'validator' ? 'validatorFileInfo' : (type === 'xml' ? 'xmlStatus' : 'excelStatus'));
            const processButton = document.getElementById(type === 'validator' ? 'validatorProcessButton' : 'compareButton');
            
            fileInfoDiv.innerHTML = `<strong>File:</strong> ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            fileInfoDiv.style.display = 'block';

            if (type === 'validator') {
                 processButton.disabled = false;
            } else {
                if (type === 'xml') globalData.xmlFile = file;
                if (type === 'excel') globalData.excelFile = file;
                document.getElementById('compareButton').disabled = !(globalData.xmlFile && globalData.excelFile);
            }
        }

        function processXmlFile() {
            const file = document.getElementById('validatorFileInput').files[0];
            if (!file) return alert('Vui l√≤ng ch·ªçn file XML!');
            
            showLoading('validatorLoading');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    globalData.xmlDataContent = e.target.result;
                    setTimeout(() => {
                        const { records, drugs, services } = validateXmlContent(globalData.xmlDataContent);
                        globalData.allRecords = records;
                        globalData.allDrugs = drugs;
                        globalData.allServices = services;
                        globalData.filteredRecords = records;
                        
                        displayValidatorResults();
                        hideLoading('validatorLoading');
                        
                        document.getElementById('validatorFilters').style.display = 'block';
                        document.getElementById('validatorResults').style.display = 'block';
                        
                        updateDashboard();
                    }, 100);
                } catch (error) {
                    hideLoading('validatorLoading');
                    alert('L·ªói x·ª≠ l√Ω file: ' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function validateXmlContent(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
            if (xmlDoc.querySelector('parsererror')) throw new Error('File XML kh√¥ng h·ª£p l·ªá.');

            const records = [];
            const drugs = [];
            const services = [];

            const hosoElements = xmlDoc.getElementsByTagName('HOSO');
            for (let hoso of hosoElements) {
                const result = validateSingleHoso(hoso);
                if (result) {
                    records.push(result.record);
                    drugs.push(...result.drugs);
                    services.push(...result.services);
                }
            }
            return { records, drugs, services };
        }
        
        function validateSingleHoso(hoso) {
            let tongHop = null, chiTietThuoc = null, chiTietDvkt = null;
            hoso.querySelectorAll('FILEHOSO').forEach(fileHoso => {
                const loai = fileHoso.querySelector('LOAIHOSO')?.textContent.trim();
                const noiDung = fileHoso.querySelector('NOIDUNGFILE');
                if (loai === 'XML1') tongHop = noiDung?.querySelector('TONG_HOP');
                if (loai === 'XML2') chiTietThuoc = noiDung;
                if (loai === 'XML3') chiTietDvkt = noiDung;
            });
            if (!tongHop) return null;

            const getText = (element, selector) => element?.querySelector(selector)?.textContent.trim() || '';

            const maLk = getText(tongHop, 'MA_LK');
            const record = {
                maLk: maLk, 
                hoTen: getText(tongHop,'HO_TEN'), 
                ngayVao: getText(tongHop,'NGAY_VAO'),
                ngayRa: getText(tongHop,'NGAY_RA'), 
                maBn: getText(tongHop,'MA_BN'), 
                maThe: getText(tongHop,'MA_THE_BHYT'),
                tongChi: parseFloat(getText(tongHop, 'T_TONGCHI') || '0'), // T·ªïng chi ph√≠
                t_bhtt: parseFloat(getText(tongHop, 'T_BHTT') || '0'), // BHYT thanh to√°n
                t_bncct: parseFloat(getText(tongHop, 'T_BNCCT') || '0'), // B·ªánh nh√¢n CCT
                gioiTinh: getText(tongHop,'GIOI_TINH'),
                ngaySinh: getText(tongHop,'NGAY_SINH'), 
                chanDoan: getText(tongHop,'CHAN_DOAN_RV'),
                maKhoa: getText(tongHop,'MA_KHOA'), 
                errors: []
            };

            const drugs = [];
            if (chiTietThuoc) {
                chiTietThuoc.querySelectorAll('CHI_TIET_THUOC').forEach(item => {
                    drugs.push({
                        ma_lk: maLk,
                        ma_thuoc: getText(item, 'MA_THUOC'),
                        ten_thuoc: getText(item, 'TEN_THUOC'),
                        so_luong: parseFloat(getText(item, 'SO_LUONG') || '0'),
                        thanh_tien_bh: parseFloat(getText(item, 'THANH_TIEN_BH') || '0')
                    });
                    const ngayYl = item.querySelector('NGAY_YL')?.textContent.trim();
                    if (ngayYl && ngayYl > record.ngayRa) record.errors.push({ type: 'NGAY_YL_THUOC_SAU_RA_VIEN', severity: 'critical', message: `Thu·ªëc "${getText(item, 'TEN_THUOC')}": YL sau ng√†y ra.` });
                    if (ngayYl && ngayYl < record.ngayVao) record.errors.push({ type: 'NGAY_YL_THUOC_NGOAI_KHOANG', severity: 'warning', message: `Thu·ªëc "${getText(item, 'TEN_THUOC')}": YL tr∆∞·ªõc ng√†y v√†o.` });
                });
            }

            const services = [];
            if (chiTietDvkt) {
                chiTietDvkt.querySelectorAll('CHI_TIET_DVKT').forEach(item => {
                    services.push({
                        ma_lk: maLk,
                        ma_dich_vu: getText(item, 'MA_DICH_VU'),
                        ten_dich_vu: getText(item, 'TEN_DICH_VU'),
                        so_luong: parseFloat(getText(item, 'SO_LUONG') || '0'),
                        thanh_tien_bh: parseFloat(getText(item, 'THANH_TIEN_BH') || '0')
                    });
                    const ngayYl = item.querySelector('NGAY_YL')?.textContent.trim();
                    if (ngayYl && ngayYl > record.ngayRa) record.errors.push({ type: 'NGAY_YL_DVKT_SAU_RA_VIEN', severity: 'critical', message: `DVKT "${getText(item, 'TEN_DICH_VU')}": YL sau ng√†y ra.` });
                    if (ngayYl && ngayYl < record.ngayVao) record.errors.push({ type: 'NGAY_YL_DVKT_NGOAI_KHOANG', severity: 'warning', message: `DVKT "${getText(item, 'TEN_DICH_VU')}": YL tr∆∞·ªõc ng√†y v√†o.` });
                });
            }

            if (record.ngayVao > record.ngayRa) record.errors.push({ type: 'NGAY_VAO_SAU_NGAY_RA', severity: 'critical', message: `Ng√†y v√†o sau ng√†y ra.` });
            
            return { record, drugs, services };
        }

        function displayValidatorResults() {
            updateErrorTypeFilter();
            applyFilters();
        }

        function updateErrorTypeFilter() {
            const errorTypeFilter = document.getElementById('errorTypeFilter');
            const errorTypes = new Set(globalData.allRecords.flatMap(r => r.errors.map(e => e.type)));
            errorTypeFilter.innerHTML = '<option value="">T·∫•t c·∫£ lo·∫°i l·ªói</option>';
            errorTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = ERROR_TYPES[type] || type;
                errorTypeFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const filters = {
                errorType: document.getElementById('errorTypeFilter').value,
                severity: document.getElementById('severityFilter').value,
                searchText: document.getElementById('searchBox').value.toLowerCase(),
                dateFrom: document.getElementById('dateFromFilter').value.replace(/-/g, ''),
                dateTo: document.getElementById('dateToFilter').value.replace(/-/g, ''),
                amountFrom: parseFloat(document.getElementById('amountFromFilter').value),
                amountTo: parseFloat(document.getElementById('amountToFilter').value),
                gender: document.getElementById('genderFilter').value,
                bncct: document.getElementById('bncctFilter').value
            };

            globalData.filteredRecords = globalData.allRecords.filter(r => {
                if (filters.errorType && !r.errors.some(e => e.type === filters.errorType)) return false;
                if (filters.severity) {
                    if (filters.severity === 'success' && r.errors.length > 0) return false;
                    if (filters.severity === 'critical' && !r.errors.some(e => e.severity === 'critical')) return false;
                    if (filters.severity === 'warning' && (!r.errors.some(e => e.severity === 'warning') || r.errors.some(e => e.severity === 'critical'))) return false;
                }
                if (filters.searchText && !`${r.hoTen} ${r.maLk} ${r.maBn}`.toLowerCase().includes(filters.searchText)) return false;
                const recordDate = String(r.ngayVao).substring(0, 8);
                if (filters.dateFrom && recordDate < filters.dateFrom) return false;
                if (filters.dateTo && recordDate > filters.dateTo) return false;
                if (!isNaN(filters.amountFrom) && r.t_bhtt < filters.amountFrom) return false;
                if (!isNaN(filters.amountTo) && r.t_bhtt > filters.amountTo) return false;
                if (filters.gender && r.gioiTinh !== filters.gender) return false;
                
                if (filters.bncct === 'yes' && (!r.t_bncct || r.t_bncct <= 0)) return false;
                if (filters.bncct === 'no' && r.t_bncct && r.t_bncct > 0) return false;

                return true;
            });
            
            globalData.currentPage = 1;
            updateResultsTable();
        }

        function updateResultsTable() {
            const tbody = document.getElementById('resultsTableBody');
            const startIndex = (globalData.currentPage - 1) * globalData.pageSize;
            const pageRecords = globalData.filteredRecords.slice(startIndex, startIndex + globalData.pageSize);
            
            tbody.innerHTML = '';
            pageRecords.forEach((record, index) => {
                const row = tbody.insertRow();
                let statusClass = 'status-success', statusText = 'üü¢ H·ª£p l·ªá';
                if (record.errors.length > 0) {
                    const isCritical = record.errors.some(e => e.severity === 'critical');
                    statusClass = isCritical ? 'status-error' : 'status-warning';
                    statusText = isCritical ? `üî¥ C√≥ ${record.errors.length} l·ªói` : `üü° C√≥ ${record.errors.length} c·∫£nh b√°o`;
                }

                const errorDetails = record.errors.map(e => `<div class="error-detail"><span class="status-badge ${e.severity === 'critical' ? 'status-error' : 'status-warning'}">${ERROR_TYPES[e.type] || e.type}</span> <small>${e.message}</small></div>`).join('');
                
                row.innerHTML = `
                    <td>${startIndex + index + 1}</td>
                    <td><strong>${record.hoTen}</strong><br><small>LK: ${record.maLk}</small>${record.maBn ? `<br><small>BN: ${record.maBn}</small>` : ''}</td>
                    <td><strong>V√†o:</strong> ${formatDateTimeForDisplay(record.ngayVao)}<br><strong>Ra:</strong> ${formatDateTimeForDisplay(record.ngayRa)}</td>
                    <td>${formatCurrency(record.t_bhtt)}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${errorDetails || '<span class="status-badge status-success">Kh√¥ng c√≥ l·ªói</span>'}</td>
                `;
            });
            
            updatePagination();
            updateResultsInfo();
        }

        function updatePagination() {
            const container = document.getElementById('paginationContainer');
            const totalPages = Math.ceil(globalData.filteredRecords.length / globalData.pageSize);
            if (totalPages <= 1) { container.innerHTML = ''; return; }

            container.innerHTML = `
                <button onclick="changePage(1)" ${globalData.currentPage === 1 ? 'disabled' : ''}>¬´ ƒê·∫ßu</button>
                <button onclick="changePage(${globalData.currentPage - 1})" ${globalData.currentPage === 1 ? 'disabled' : ''}>‚Äπ Tr∆∞·ªõc</button>
                <span class="page-info">Trang ${globalData.currentPage} / ${totalPages}</span>
                <button onclick="changePage(${globalData.currentPage + 1})" ${globalData.currentPage === totalPages ? 'disabled' : ''}>Ti·∫øp ‚Ä∫</button>
                <button onclick="changePage(${totalPages})" ${globalData.currentPage === totalPages ? 'disabled' : ''}>Cu·ªëi ¬ª</button>
            `;
        }
        
        function changePage(page) {
            globalData.currentPage = page;
            updateResultsTable();
        }
        
        function updateResultsInfo() {
            const info = document.getElementById('resultsInfo');
            const total = globalData.filteredRecords.length;
            const start = total > 0 ? (globalData.currentPage - 1) * globalData.pageSize + 1 : 0;
            const end = Math.min(globalData.currentPage * globalData.pageSize, total);
            info.textContent = `Hi·ªÉn th·ªã ${start}-${end} trong t·ªïng s·ªë ${total.toLocaleString('vi-VN')} k·∫øt qu·∫£`;
        }

        function clearFilters() {
            document.getElementById('validatorFilters').querySelectorAll('input, select').forEach(el => {
                if (el.type !== 'button') el.value = '';
            });
            applyFilters();
        }

        function exportToExcel(errorsOnly = false) {
            const recordsToExport = errorsOnly 
                ? globalData.filteredRecords.filter(r => r.errors.length > 0)
                : globalData.filteredRecords;

            if (recordsToExport.length === 0) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
            
            const wb = XLSX.utils.book_new();
            
            const stats = calculateGlobalStats(recordsToExport);
            const summaryData = [
                ['B√ÅO C√ÅO KI·ªÇM TRA FILE XML BHYT'],
                ['Th·ªùi gian t·∫°o:', new Date().toLocaleString('vi-VN')], [],
                ['TH·ªêNG K√ä T·ªîNG QUAN'],
                ['T·ªïng h·ªì s∆° ƒë√£ l·ªçc:', recordsToExport.length],
                ['T·ªïng chi ph√≠ BHYT TT:', stats.totalAmount],
                ['T·ª∑ l·ªá l·ªói:', `${stats.errorRate.toFixed(2)}%`], [],
                ['PH√ÇN B·ªê L·ªñI'],
                ['Lo·∫°i l·ªói', 'S·ªë l∆∞·ª£ng']
            ];
            Object.entries(stats.errorTypes).forEach(([type, count]) => {
                summaryData.push([ERROR_TYPES[type] || type, count]);
            });
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Tong_Quan');

            const data = recordsToExport.map((r, i) => ({
                'STT': i + 1, 'H·ªç T√™n': r.hoTen, 'M√£ LK': r.maLk, 'M√£ BN': r.maBn,
                'Ng√†y V√†o': formatDateTimeForDisplay(r.ngayVao), 'Ng√†y Ra': formatDateTimeForDisplay(r.ngayRa),
                'T·ªïng Chi Ph√≠ BHYT TT': r.t_bhtt, 'BN CCT': r.t_bncct,
                'Tr·∫°ng Th√°i': r.errors.length > 0 ? (r.errors.some(e => e.severity === 'critical') ? 'L·ªói nghi√™m tr·ªçng' : 'C·∫£nh b√°o') : 'H·ª£p l·ªá',
                'Chi Ti·∫øt L·ªói': r.errors.map(e => `${ERROR_TYPES[e.type] || e.type}: ${e.message}`).join('\n')
            }));
            const wsData = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, wsData, 'Chi_Tiet');

            XLSX.writeFile(wb, errorsOnly ? 'BaoCaoLoi_BHYT.xlsx' : 'BaoCaoKiemTra_BHYT.xlsx');
        }
        
        // ============================= COMPARATOR FUNCTIONALITY (UPGRADED) =============================
        function initializeComparator() {
            document.getElementById('comparatorXmlInput').addEventListener('change', (e) => handleFileUpload(e, 'xml'));
            document.getElementById('comparatorExcelInput').addEventListener('change', (e) => handleFileUpload(e, 'excel'));
            document.getElementById('compareButton').addEventListener('click', performComparison);
        }

        function findKey(obj, possibleKeys) {
            if(!obj) return null;
            const upperKeys = possibleKeys.map(k => k.toUpperCase().replace(/ /g, ''));
            for (const key in obj) {
                if (upperKeys.includes(key.trim().toUpperCase().replace(/ /g, ''))) {
                    return key;
                }
            }
            return null;
        }

        async function performComparison() {
            showLoading('comparatorLoading');
            try {
                // 1. Read XML File
                const xmlContent = await globalData.xmlFile.text();
                const { records: xmlRecordsRaw } = validateXmlContent(xmlContent); // Only need records for comparison
                globalData.xmlRecords.clear();
                xmlRecordsRaw.forEach(r => globalData.xmlRecords.set(r.maLk, r));

                // 2. Read Excel/CSV File
                globalData.excelRecords.clear();
                const file = globalData.excelFile;
                const isCSV = file.name.toLowerCase().endsWith('.csv');

                let excelJson;
                if (isCSV) {
                    const text = await file.text();
                    const workbook = XLSX.read(text, {type: 'string'});
                    const sheetName = workbook.SheetNames[0];
                    excelJson = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                } else {
                    const excelBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(excelBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    excelJson = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                }

                excelJson.forEach(row => {
                    const maLkKey = findKey(row, ['MA_LK', 'M√É LK', 'M√É LI√äN K·∫æT']);
                    if(maLkKey && row[maLkKey]) {
                        globalData.excelRecords.set(String(row[maLkKey]), row);
                    }
                });
                
                // 3. Compare Data
                const allKeys = new Set([...globalData.xmlRecords.keys(), ...globalData.excelRecords.keys()]);
                globalData.comparisonResults = [];
                for (const key of allKeys) {
                    const xmlRec = globalData.xmlRecords.get(key);
                    const excelRec = globalData.excelRecords.get(key);
                    
                    let result = { key, xmlRec, excelRec, status: 'mismatch', details: [] };
                    
                    if (xmlRec && excelRec) {
                        // Compare T_BHTT
                        const t_bhtt_xml = xmlRec.t_bhtt || 0;
                        const t_bhtt_excel_key = findKey(excelRec, ['B·∫¢O HI·ªÇM TT', 'BAOHIEMTT', 'T_BHTT']);
                        const t_bhtt_excel = t_bhtt_excel_key ? (parseFloat(excelRec[t_bhtt_excel_key]) || 0) : 0;
                        if(Math.abs(t_bhtt_xml - t_bhtt_excel) > 1) { 
                            result.details.push(`BHYT TT: XML=${formatCurrency(t_bhtt_xml)} vs Excel=${formatCurrency(t_bhtt_excel)}`);
                        }
                        
                        // Compare T_BNCCT
                        const t_bncct_xml = xmlRec.t_bncct || 0;
                        const t_bncct_excel_key = findKey(excelRec, ['B·ªÜNH NH√ÇN CCT', 'BENHNHANCCT', 'T_BNCCT']);
                        const t_bncct_excel = t_bncct_excel_key ? (parseFloat(excelRec[t_bncct_excel_key]) || 0) : 0;
                         if(Math.abs(t_bncct_xml - t_bncct_excel) > 1) {
                            result.details.push(`BN CCT: XML=${formatCurrency(t_bncct_xml)} vs Excel=${formatCurrency(t_bncct_excel)}`);
                        }
                        
                        result.status = result.details.length === 0 ? 'match' : 'mismatch';

                    } else if (xmlRec) {
                        result.status = 'xml-only';
                    } else {
                        result.status = 'excel-only';
                    }
                    globalData.comparisonResults.push(result);
                }
                
                hideLoading('comparatorLoading');
                document.getElementById('comparatorResults').style.display = 'block';
                applyComparatorFilters();

            } catch (error) {
                hideLoading('comparatorLoading');
                console.error("Comparison Error:", error);
                alert(`L·ªói ƒë·ªëi chi·∫øu: ${error.message}`);
            }
        }
        
        function applyComparatorFilters() {
            const status = document.getElementById('statusFilter').value;
            const maLk = document.getElementById('maLkSearch').value.toLowerCase();
            const patientName = document.getElementById('patientSearch').value.toLowerCase();

            globalData.filteredComparisonResults = globalData.comparisonResults.filter(r => {
                if (status && r.status !== status) return false;
                if (maLk && !r.key.toLowerCase().includes(maLk)) return false;
                if (patientName) {
                    const xmlName = r.xmlRec?.hoTen?.toLowerCase() || '';
                    const excelHoTenKey = r.excelRec ? findKey(r.excelRec, ['HO_TEN', 'H·ªå T√äN']) : null;
                    const excelName = excelHoTenKey ? String(r.excelRec[excelHoTenKey]).toLowerCase() : '';
                    if (!xmlName.includes(patientName) && !excelName.includes(patientName)) return false;
                }
                return true;
            });
            displayComparatorResults();
        }

        function displayComparatorResults() {
            const wrapper = document.getElementById('comparatorResultsTableWrapper');
            const info = document.getElementById('comparatorResultsInfo');
            
            let tableHTML = `<table class="results-table"><thead><tr>
                <th>M√£ LK</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Th√¥ng tin XML</th>
                <th>Th√¥ng tin file ƒë·ªëi chi·∫øu</th>
                <th>Chi ti·∫øt kh√¥ng kh·ªõp</th>
            </tr></thead><tbody>`;

            if (globalData.filteredComparisonResults.length === 0) {
                tableHTML += `<tr><td colspan="5" style="text-align:center;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</td></tr>`;
            } else {
                globalData.filteredComparisonResults.forEach(r => {
                    const xmlName = r.xmlRec?.hoTen || 'N/A';
                    const xml_t_bhtt = r.xmlRec ? formatCurrency(r.xmlRec.t_bhtt) : 'N/A';
                    const xml_t_bncct = r.xmlRec ? formatCurrency(r.xmlRec.t_bncct) : 'N/A';

                    const excelHoTenKey = r.excelRec ? findKey(r.excelRec, ['HO_TEN', 'H·ªå T√äN']) : null;
                    const excelName = excelHoTenKey ? r.excelRec[excelHoTenKey] : 'N/A';
                    
                    const excelBHTTKey = r.excelRec ? findKey(r.excelRec, ['B·∫¢O HI·ªÇM TT', 'BAOHIEMTT', 'T_BHTT']) : null;
                    const excel_t_bhtt = excelBHTTKey ? formatCurrency(r.excelRec[excelBHTTKey]) : 'N/A';

                    const excelBNCCTKey = r.excelRec ? findKey(r.excelRec, ['B·ªÜNH NH√ÇN CCT', 'BENHNHANCCT', 'T_BNCCT']) : null;
                    const excel_t_bncct = excelBNCCTKey ? formatCurrency(r.excelRec[excelBNCCTKey]) : 'N/A';
                    
                    const statusMap = {
                        match: { text: '‚úÖ Kh·ªõp', class: 'status-match' },
                        mismatch: { text: '‚ùå Kh√¥ng kh·ªõp', class: 'status-mismatch' },
                        'xml-only': { text: 'üìÑ Ch·ªâ c√≥ trong XML', class: 'status-xml-only' },
                        'excel-only': { text: 'üìä Ch·ªâ c√≥ trong file ƒë·ªëi chi·∫øu', class: 'status-excel-only' }
                    };
                    
                    const isMismatch = r.status === 'mismatch';
                    
                    let detailsHtml = '';
                    if (r.details && r.details.length > 0) {
                        detailsHtml = `<div class="comparator-details"><ul><li>${r.details.join('</li><li>')}</li></ul></div>`;
                    }

                    tableHTML += `
                        <tr class="${r.status}">
                            <td>${r.key}</td>
                            <td><span class="status-badge ${statusMap[r.status].class}">${statusMap[r.status].text}</span></td>
                            <td>
                                <strong>${xmlName}</strong><br>
                                <span ${isMismatch ? 'style="color:red;"':''}>BHYT TT: ${xml_t_bhtt}</span><br>
                                <span ${isMismatch ? 'style="color:red;"':''}>BN CCT: ${xml_t_bncct}</span>
                            </td>
                            <td>
                                <strong>${excelName}</strong><br>
                                <span ${isMismatch ? 'style="color:red;"':''}>BHYT TT: ${excel_t_bhtt}</span><br>
                                <span ${isMismatch ? 'style="color:red;"':''}>BN CCT: ${excel_t_bncct}</span>
                            </td>
                            <td>${detailsHtml}</td>
                        </tr>
                    `;
                });
            }

            tableHTML += '</tbody></table>';
            wrapper.innerHTML = tableHTML;
            info.textContent = `T√¨m th·∫•y ${globalData.filteredComparisonResults.length.toLocaleString('vi-VN')} k·∫øt qu·∫£.`;
        }
        
        function clearComparatorFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('maLkSearch').value = '';
            document.getElementById('patientSearch').value = '';
            applyComparatorFilters();
        }

        function exportComparatorResults() {
            if (globalData.filteredComparisonResults.length === 0) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
            
            const data = globalData.filteredComparisonResults.map(r => {
                 const excelHoTenKey = r.excelRec ? findKey(r.excelRec, ['HO_TEN', 'H·ªå T√äN']) : null;
                 const excelBHTTKey = r.excelRec ? findKey(r.excelRec, ['B·∫¢O HI·ªÇM TT', 'BAOHIEMTT', 'T_BHTT']) : null;
                 const excelBNCCTKey = r.excelRec ? findKey(r.excelRec, ['B·ªÜNH NH√ÇN CCT', 'BENHNHANCCT', 'T_BNCCT']) : null;
                 return {
                    'M√£ LK': r.key,
                    'Tr·∫°ng th√°i': r.status,
                    'T√™n BN (XML)': r.xmlRec?.hoTen,
                    'BHYT TT (XML)': r.xmlRec?.t_bhtt,
                    'BN CCT (XML)': r.xmlRec?.t_bncct,
                    'T√™n BN (File ƒë·ªëi chi·∫øu)': excelHoTenKey ? r.excelRec[excelHoTenKey] : null,
                    'BHYT TT (File ƒë·ªëi chi·∫øu)': excelBHTTKey ? r.excelRec[excelBHTTKey] : null,
                    'BN CCT (File ƒë·ªëi chi·∫øu)': excelBNCCTKey ? r.excelRec[excelBNCCTKey] : null,
                    'Chi ti·∫øt kh√¥ng kh·ªõp': r.details ? r.details.join('; ') : ''
                 };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KetQuaDoiChieu");
            XLSX.writeFile(wb, "BaoCaoDoiChieu_BHYT.xlsx");
        }

        // ============================= REPORTS TAB =============================
        function generateReport() {
            if (globalData.allRecords.length === 0) {
                alert('Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra m·ªôt file XML tr∆∞·ªõc.');
                return;
            }

            const reportType = document.getElementById('reportType').value;
            const dateFrom = document.getElementById('reportDateFrom').value.replace(/-/g, '');
            const dateTo = document.getElementById('reportDateTo').value.replace(/-/g, '');

            const filteredForReport = globalData.allRecords.filter(r => {
                if (!dateFrom && !dateTo) return true;
                const recordDate = String(r.ngayVao).substring(0, 8);
                if (dateFrom && recordDate < dateFrom) return false;
                if (dateTo && recordDate > dateTo) return false;
                return true;
            });
            
            const stats = calculateGlobalStats(filteredForReport);
            let chart1Type, chart1Data, chart1Title;
            let chart2Type, chart2Data, chart2Title;

            switch(reportType) {
                case 'error-summary':
                    const sortedErrors = Object.entries(stats.errorTypes).sort(([, a], [, b]) => b - a);
                    chart1Type = 'bar';
                    chart1Data = {
                        labels: sortedErrors.map(([key]) => ERROR_TYPES[key] || key),
                        datasets: [{ label: 'S·ªë L·∫ßn Xu·∫•t Hi·ªán', data: sortedErrors.map(([, count]) => count), backgroundColor: 'rgba(220, 53, 69, 0.8)' }]
                    };
                    chart1Title = 'Th·ªëng K√™ C√°c Lo·∫°i L·ªói Ph·ªï Bi·∫øn';

                    chart2Type = 'doughnut';
                    chart2Data = {
                        labels: ['H·ªì S∆° H·ª£p L·ªá', 'H·ªì S∆° C√≥ L·ªói'],
                        datasets: [{ data: [stats.totalRecords - stats.errorRecordsCount, stats.errorRecordsCount], backgroundColor: ['#28a745', '#dc3545'] }]
                    };
                    chart2Title = 'T·ª∑ L·ªá H·ªì S∆° L·ªói v√† H·ª£p L·ªá';
                    break;
                case 'time-analysis':
                    const sortedTimeline = Object.entries(stats.timeline).sort(([a], [b]) => a.localeCompare(b));
                    chart1Type = 'line';
                    chart1Data = {
                        labels: sortedTimeline.map(([month]) => `${month.substring(4,6)}/${month.substring(0,4)}`),
                        datasets: [{ label: 'S·ªë H·ªì S∆°', data: sortedTimeline.map(([, count]) => count), borderColor: '#667eea', tension: 0.1 }]
                    };
                    chart1Title = 'Ph√¢n T√≠ch S·ªë L∆∞·ª£ng H·ªì S∆° Theo Th·ªùi Gian';

                    const errorTimeline = {};
                    filteredForReport.forEach(r => {
                        if (r.errors.length > 0) {
                            const month = String(r.ngayVao).substring(0, 6);
                            errorTimeline[month] = (errorTimeline[month] || 0) + 1;
                        }
                    });
                    const filledErrorTimelineData = sortedTimeline.map(([month]) => errorTimeline[month] || 0);
                    chart2Type = 'line';
                    chart2Data = {
                        labels: sortedTimeline.map(([month]) => `${month.substring(4,6)}/${month.substring(0,4)}`),
                        datasets: [{ label: 'S·ªë H·ªì S∆° L·ªói', data: filledErrorTimelineData, borderColor: '#dc3545', tension: 0.1 }]
                    };
                    chart2Title = 'Ph√¢n T√≠ch S·ªë L∆∞·ª£ng L·ªói Theo Th·ªùi Gian';
                    break;
                case 'cost-analysis':
                    chart1Type = 'bar';
                    chart1Data = {
                        labels: Object.keys(stats.amounts),
                        datasets: [{ label: 'S·ªë H·ªì S∆°', data: Object.values(stats.amounts), backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545', '#6f42c1'] }]
                    };
                    chart1Title = 'Ph√¢n B·ªë H·ªì S∆° Theo Kho·∫£ng Chi Ph√≠ BHYT TT';

                     const costByMonth = {};
                     filteredForReport.forEach(r => {
                         const month = String(r.ngayVao).substring(0, 6);
                         costByMonth[month] = (costByMonth[month] || 0) + r.t_bhtt;
                     });
                    const sortedCostByMonth = Object.entries(costByMonth).sort(([a], [b]) => a.localeCompare(b));
                    chart2Type = 'bar';
                    chart2Data = {
                         labels: sortedCostByMonth.map(([month]) => `${month.substring(4,6)}/${month.substring(0,4)}`),
                        datasets: [{ label: 'T·ªïng Chi Ph√≠ BHYT TT (VNƒê)', data: sortedCostByMonth.map(([, cost]) => cost), backgroundColor: 'rgba(54, 162, 235, 0.8)' }]
                    };
                    chart2Title = 'T·ªïng Chi Ph√≠ BHYT TT Theo Th·ªùi Gian';
                    break;
                case 'department-analysis':
                    const sortedDepts = Object.entries(stats.departments).sort(([, a], [, b]) => b - a).slice(0, 15);
                    chart1Type = 'bar';
                    chart1Data = {
                        labels: sortedDepts.map(([name]) => name || 'Kh√¥ng x√°c ƒë·ªãnh'),
                        datasets: [{ label: 'S·ªë H·ªì S∆°', data: sortedDepts.map(([, count]) => count), backgroundColor: 'rgba(75, 192, 192, 0.8)'}]
                    };
                    chart1Title = 'Top 15 Khoa Theo S·ªë L∆∞·ª£ng H·ªì S∆°';

                    const costByDept = {};
                    filteredForReport.forEach(r => {
                        costByDept[r.maKhoa] = (costByDept[r.maKhoa] || 0) + r.t_bhtt;
                    });
                    const sortedCostDepts = sortedDepts.map(([name]) => ({
                        name: name || 'Kh√¥ng x√°c ƒë·ªãnh',
                        cost: costByDept[name] || 0
                    }));
                     chart2Type = 'bar';
                     chart2Data = {
                        labels: sortedCostDepts.map(d => d.name),
                        datasets: [{ label: 'T·ªïng Chi Ph√≠ BHYT TT (VNƒê)', data: sortedCostDepts.map(d => d.cost), backgroundColor: 'rgba(153, 102, 255, 0.8)' }]
                     };
                     chart2Title = 'Top 15 Khoa Theo T·ªïng Chi Ph√≠ BHYT TT';
                    break;
            }
            updateChart('reportChart1', chart1Type, chart1Data, chart1Title);
            updateChart('reportChart2', chart2Type, chart2Data, chart2Title);
        }

        function exportReport() {
            alert('Ch·ª©c nƒÉng xu·∫•t b√°o c√°o chuy√™n s√¢u ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng s·ª≠ d·ª•ng ch·ª©c nƒÉng "Xu·∫•t Excel" ·ªü tab Ki·ªÉm tra XML.');
        }

        // ============================= INITIALIZATION =============================
        document.addEventListener('DOMContentLoaded', () => {
            initializeValidator();
            initializeComparator();
            
            document.querySelectorAll('.filter-content').forEach(el => {
                const parent = el.parentElement;
                const toggleButton = parent.querySelector('.filter-toggle');
                if (toggleButton) {
                     el.style.display = 'none';
                    if(parent.querySelector('.filter-actions')) parent.querySelector('.filter-actions').style.display = 'none';
                    toggleButton.textContent = 'M·ªü r·ªông';
                }
            });

            Object.keys(globalData.charts).forEach(key => {
                if(globalData.charts[key] && typeof globalData.charts[key].destroy === 'function') {
                    globalData.charts[key].destroy();
                }
            });
            updateChart('errorTypesChart', 'doughnut', {labels:[], datasets:[{data:[]}]}, 'Ph√¢n b·ªë lo·∫°i l·ªói (ch∆∞a c√≥ d·ªØ li·ªáu)');
            updateChart('timelineChart', 'line', {labels:[], datasets:[{data:[]}]}, 'Xu h∆∞·ªõng theo th·ªùi gian (ch∆∞a c√≥ d·ªØ li·ªáu)');
            updateChart('departmentChart', 'bar', {labels:[], datasets:[{data:[]}]}, 'Ph√¢n b·ªë theo khoa (ch∆∞a c√≥ d·ªØ li·ªáu)');
            updateChart('amountChart', 'bar', {labels:[], datasets:[{data:[]}]}, 'Ph√¢n b·ªë chi ph√≠ (ch∆∞a c√≥ d·ªØ li·ªáu)');
            updateChart('reportChart1', 'bar', {labels:[], datasets:[{data:[]}]}, 'B√°o c√°o 1 (ch∆∞a c√≥ d·ªØ li·ªáu)');
            updateChart('reportChart2', 'bar', {labels:[], datasets:[{data:[]}]}, 'B√°o c√°o 2 (ch∆∞a c√≥ d·ªØ li·ªáu)');
            updateChart('topDrugsChart', 'bar', {labels:[], datasets:[{data:[]}]}, 'Top 10 Thu·ªëc (ch∆∞a c√≥ d·ªØ li·ªáu)');
            updateChart('topServicesChart', 'bar', {labels:[], datasets:[{data:[]}]}, 'Top 10 DVKT (ch∆∞a c√≥ d·ªØ li·ªáu)');
        });

    </script>
</body>
</html>
