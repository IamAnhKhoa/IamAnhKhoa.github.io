<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard BHYT Toàn diện</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Global Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
            line-height: 1.6; 
        }
        
        .container { 
            max-width: 1800px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); 
            overflow: hidden; 
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0.5;
            animation: rotate 20s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        /* Tab Navigation */
        .tab-nav { 
            display: flex; 
            background: #f8f9fa; 
            border-bottom: 3px solid #dee2e6; 
        }
        
        .tab-button { 
            flex: 1; 
            padding: 20px 30px; 
            border: none; 
            background: transparent; 
            font-size: 1.1em; 
            font-weight: 600; 
            color: #6c757d; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            position: relative; 
        }
        
        .tab-button:hover { 
            background: rgba(102, 126, 234, 0.1); 
            color: #667eea; 
            transform: translateY(-2px);
        }
        
        .tab-button.active { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .tab-content { 
            display: none; 
            padding: 30px; 
            animation: fadeIn 0.5s ease; 
        }
        
        .tab-content.active { display: block; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .stat-card p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            height: 400px;
        }
        
        /* Advanced Filters */
        .advanced-filters {
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .filter-header h3 {
            color: #2c3e50;
            font-size: 1.4em;
        }
        
        .filter-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .filter-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
        }
        
        .filter-input, .filter-select {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }
        
        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .date-range-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .filter-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* File Upload Area */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 50px 30px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #e6f3ff 0%, #d4edda 100%);
        }
        
        .upload-area.drag-over {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            transform: scale(1.02);
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 20px;
        }
        
        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 25px;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }
        
        .file-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        /* Results Table */
        .results-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 30px;
        }
        
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }
        
        .results-table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.3s ease;
            vertical-align: top;
        }
        
        .results-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .results-table .error-detail {
            margin-bottom: 5px;
        }
        .comparator-details ul {
            padding-left: 20px;
            margin: 0;
            font-size: 0.9em;
        }
        .comparator-details li {
            color: #c53030;
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 2px;
        }
        
        .status-success { background: #d4edda; color: #155724; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-mismatch { background: #f8d7da; color: #721c24; }
        .status-match { background: #d4edda; color: #155724; }
        .status-xml-only { background: #d1ecf1; color: #0c5460; }
        .status-excel-only { background: #e2e3e5; color: #383d41; }
        
        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }
        
        .loading.show { display: block; }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-nav {
                flex-direction: column;
            }
            
            .filter-actions {
                flex-direction: column;
            }
        }
        
        /* Pagination */
        .pagination {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .pagination button {
            padding: 8px 15px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination .page-info {
            margin: 0 15px;
            font-weight: 600;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🏥 Dashboard BHYT Toàn diện</h1>
            <p>Hệ thống quản lý và phân tích dữ liệu BHYT với dashboard thông minh</p>
        </header>

        <nav class="tab-nav">
            <button class="tab-button active" onclick="openTab(event, 'dashboardTab')">📊 Dashboard</button>
            <button class="tab-button" onclick="openTab(event, 'validatorTab')">📋 Kiểm tra XML</button>
            <button class="tab-button" onclick="openTab(event, 'comparatorTab')">🔄 Đối chiếu</button>
            <button class="tab-button" onclick="openTab(event, 'reportsTab')">📈 Báo cáo</button>
        </nav>

        <div id="dashboardTab" class="tab-content active">
            <div class="stats-overview" id="dashboardStats">
                <div class="stat-card">
                    <h3 id="totalFiles">0</h3>
                    <p>Tổng file đã xử lý</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalRecords">0</h3>
                    <p>Tổng hồ sơ</p>
                </div>
                <div class="stat-card">
                    <h3 id="errorRate">0%</h3>
                    <p>Tỷ lệ lỗi</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalAmount">0</h3>
                    <p>Tổng chi phí (VNĐ)</p>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container">
                    <canvas id="errorTypesChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container">
                    <canvas id="departmentChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="amountChart"></canvas>
                </div>
            </div>
        </div>

        <div id="validatorTab" class="tab-content">
            <div class="upload-area" id="validatorUploadArea">
                <h2>📁 Tải lên file XML BHYT</h2>
                <p>Kéo thả file XML vào đây hoặc click để chọn file</p>
                <div class="file-input-wrapper">
                    <input type="file" class="file-input" id="validatorFileInput" accept=".xml">
                    <button class="file-button">Chọn file XML</button>
                </div>
                <div id="validatorFileInfo" style="display:none; margin-top: 15px; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 8px;"></div>
                <button class="btn btn-primary" id="validatorProcessButton" style="margin-top: 20px;" disabled>🚀 Bắt đầu kiểm tra</button>
            </div>

            <div class="loading" id="validatorLoading">
                <div class="spinner"></div>
                <p>Đang xử lý file XML...</p>
            </div>

            <div class="advanced-filters" id="validatorFilters" style="display: none;">
                <div class="filter-header">
                    <h3>🔍 Bộ lọc nâng cao</h3>
                    <button class="filter-toggle" onclick="toggleFilterVisibility('validatorFilters')">Thu gọn</button>
                </div>
                
                <div class="filter-content">
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label>Loại lỗi:</label>
                            <select class="filter-select" id="errorTypeFilter">
                                <option value="">Tất cả loại lỗi</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Mức độ:</label>
                            <select class="filter-select" id="severityFilter">
                                <option value="">Tất cả mức độ</option>
                                <option value="critical">🔴 Nghiêm trọng</option>
                                <option value="warning">🟡 Cảnh báo</option>
                                <option value="success">🟢 Hợp lệ</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Tìm kiếm:</label>
                            <input type="text" class="filter-input" id="searchBox" placeholder="Tên, mã LK, mã BN...">
                        </div>
                        
                        <div class="filter-group">
                            <label>Khoảng thời gian vào viện:</label>
                            <div class="date-range-group">
                                <input type="date" class="filter-input" id="dateFromFilter">
                                <input type="date" class="filter-input" id="dateToFilter">
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label>Khoảng chi phí (VNĐ):</label>
                            <div class="date-range-group">
                                <input type="number" class="filter-input" id="amountFromFilter" placeholder="Từ">
                                <input type="number" class="filter-input" id="amountToFilter" placeholder="Đến">
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label>Giới tính:</label>
                            <select class="filter-select" id="genderFilter">
                                <option value="">Tất cả</option>
                                <option value="1">Nam</option>
                                <option value="2">Nữ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="applyFilters()">🔍 Áp dụng lọc</button>
                        <button class="btn btn-warning" onclick="clearFilters()">🔄 Xóa bộ lọc</button>
                        <button class="btn btn-success" onclick="exportToExcel(false)">📊 Xuất Excel</button>
                        <button class="btn btn-danger" onclick="exportToExcel(true)">⚠️ Chỉ xuất lỗi</button>
                    </div>
                </div>
            </div>

            <div class="results-container" id="validatorResults" style="display: none;">
                <div class="table-header">
                    <h3>📋 Kết quả kiểm tra</h3>
                    <div id="resultsInfo" style="font-size: 0.9em; opacity: 0.9;"></div>
                </div>
                
                <div style="overflow-x: auto; max-height: 600px;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Thông tin BN</th>
                                <th>Thời gian điều trị</th>
                                <th>Chi phí</th>
                                <th>Trạng thái</th>
                                <th>Chi tiết lỗi</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="paginationContainer">
                </div>
            </div>
        </div>

        <div id="comparatorTab" class="tab-content">
            <div class="upload-area">
                <h2>🔄 Đối chiếu XML & Excel/CSV</h2>
                <p>Tải lên cả file XML và file đối chiếu (Excel hoặc CSV)</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <div>
                        <h3>📄 File XML BHYT</h3>
                        <div class="file-input-wrapper" style="width: 100%;">
                            <input type="file" class="file-input" id="comparatorXmlInput" accept=".xml">
                            <button class="file-button" style="width: 100%;">Chọn file XML</button>
                        </div>
                        <div id="xmlStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
                    </div>
                    
                    <div>
                        <h3>📊 File đối chiếu (Excel/CSV)</h3>
                        <div class="file-input-wrapper" style="width: 100%;">
                            <input type="file" class="file-input" id="comparatorExcelInput" accept=".xlsx,.xls,.csv">
                            <button class="file-button" style="width: 100%;">Chọn file Excel/CSV</button>
                        </div>
                        <div id="excelStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" id="compareButton" disabled>⚡ Bắt đầu đối chiếu</button>
                </div>
            </div>

            <div class="loading" id="comparatorLoading">
                <div class="spinner"></div>
                <p>Đang đối chiếu dữ liệu...</p>
            </div>

            <div id="comparatorResults" style="display: none;">
                <div class="advanced-filters">
                    <div class="filter-header">
                        <h3>🔍 Lọc kết quả đối chiếu</h3>
                    </div>
                    
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label>Trạng thái:</label>
                            <select class="filter-select" id="statusFilter" onchange="applyComparatorFilters()">
                                <option value="">Tất cả</option>
                                <option value="match">✅ Khớp</option>
                                <option value="mismatch">❌ Không khớp</option>
                                <option value="xml-only">📄 Chỉ có trong XML</option>
                                <option value="excel-only">📊 Chỉ có trong file đối chiếu</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>Tìm mã LK:</label>
                            <input type="text" class="filter-input" id="maLkSearch" placeholder="Nhập mã LK..." oninput="applyComparatorFilters()">
                        </div>
                        
                        <div class="filter-group">
                            <label>Tìm tên BN:</label>
                            <input type="text" class="filter-input" id="patientSearch" placeholder="Nhập tên bệnh nhân..." oninput="applyComparatorFilters()">
                        </div>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="btn btn-warning" onclick="clearComparatorFilters()">🔄 Xóa lọc</button>
                        <button class="btn btn-success" onclick="exportComparatorResults()">📊 Xuất Excel</button>
                    </div>
                </div>
                
                <div class="results-container">
                    <div class="table-header">
                        <h3>📋 Kết quả đối chiếu</h3>
                        <div id="comparatorResultsInfo"></div>
                    </div>
                    
                    <div style="overflow-x: auto; max-height: 600px;" id="comparatorResultsTableWrapper">
                        </div>
                </div>
            </div>
        </div>

        <div id="reportsTab" class="tab-content">
             <div class="advanced-filters">
                <div class="filter-header">
                    <h3>📊 Tùy chọn báo cáo</h3>
                </div>
                
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Loại báo cáo:</label>
                        <select class="filter-select" id="reportType">
                            <option value="error-summary" selected>Tóm tắt lỗi</option>
                            <option value="time-analysis">Phân tích theo thời gian</option>
                            <option value="cost-analysis">Phân tích chi phí</option>
                            <option value="department-analysis">Phân tích theo khoa</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Khoảng thời gian (Ngày vào):</label>
                        <div class="date-range-group">
                            <input type="date" class="filter-input" id="reportDateFrom">
                            <input type="date" class="filter-input" id="reportDateTo">
                        </div>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="generateReport()">📈 Tạo báo cáo</button>
                    <button class="btn btn-success" onclick="exportReport()">📊 Xuất báo cáo</button>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container" id="reportChart1Container">
                     <canvas id="reportChart1"></canvas>
                </div>
                <div class="chart-container" id="reportChart2Container">
                    <canvas id="reportChart2"></canvas>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // ============================= GLOBAL VARIABLES & UTILITIES =============================
        let globalData = {
            allRecords: [],
            filteredRecords: [],
            currentPage: 1,
            pageSize: 50,
            xmlDataContent: null,
            xmlFile: null,
            excelFile: null,
            xmlRecords: new Map(),
            excelRecords: new Map(),
            comparisonResults: [],
            filteredComparisonResults: [],
            charts: {}
        };

        const ERROR_TYPES = {
            'NGAY_YL_THUOC_SAU_RA_VIEN': 'Thuốc - YL sau ra viện',
            'NGAY_YL_DVKT_SAU_RA_VIEN': 'DVKT - YL sau ra viện',
            'NGAY_YL_THUOC_NGOAI_KHOANG': 'Thuốc - YL ngoài khoảng',
            'NGAY_YL_DVKT_NGOAI_KHOANG': 'DVKT - YL ngoài khoảng',
            'NGAY_VAO_SAU_NGAY_RA': 'Ngày vào sau ngày ra',
            'THE_BHYT_HET_HAN': 'Thẻ BHYT hết hạn',
        };

        // Utility functions
        const formatDateTimeForDisplay = (dateString) => {
            if (!dateString) return '';
            const s = String(dateString).trim();
            if (s.length >= 8) {
                const year = s.substring(0, 4);
                const month = s.substring(4, 6);
                const day = s.substring(6, 8);
                let formatted = `${day}/${month}/${year}`;
                if (s.length >= 12) {
                    const hour = s.substring(8, 10);
                    const minute = s.substring(10, 12);
                    formatted += ` ${hour}:${minute}`;
                }
                return formatted;
            }
            return dateString; // Fallback
        };
        
        const formatCurrency = (amount) => {
            const num = Number(amount);
            if (isNaN(num)) return 'N/A';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(num);
        };
        
        const showLoading = (id) => document.getElementById(id).classList.add('show');
        const hideLoading = (id) => document.getElementById(id).classList.remove('show');

        // ============================= TAB MANAGEMENT =============================
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            
            if (tabName === 'dashboardTab' && globalData.allRecords.length > 0) {
                updateDashboard();
            } else if (tabName === 'reportsTab' && globalData.allRecords.length > 0) {
                 generateReport();
            }
        }

        function toggleFilterVisibility(filterContainerId) {
            const filterContent = document.querySelector(`#${filterContainerId} .filter-content`);
            const toggleButton = document.querySelector(`#${filterContainerId} .filter-toggle`);
            if (filterContent.style.display === 'none' || !filterContent.style.display) {
                filterContent.style.display = 'grid';
                 if(document.querySelector(`#${filterContainerId} .filter-actions`)) {
                    document.querySelector(`#${filterContainerId} .filter-actions`).style.display = 'flex';
                }
                toggleButton.textContent = 'Thu gọn';
            } else {
                filterContent.style.display = 'none';
                 if(document.querySelector(`#${filterContainerId} .filter-actions`)) {
                    document.querySelector(`#${filterContainerId} .filter-actions`).style.display = 'none';
                }
                toggleButton.textContent = 'Mở rộng';
            }
        }

        // ============================= DASHBOARD & REPORTS FUNCTIONALITY =============================
        function updateDashboard() {
            if (globalData.allRecords.length === 0) return;

            const stats = calculateGlobalStats(globalData.allRecords);
            
            document.getElementById('totalFiles').textContent = globalData.xmlDataContent ? 1 : 0;
            document.getElementById('totalRecords').textContent = stats.totalRecords.toLocaleString('vi-VN');
            document.getElementById('errorRate').textContent = stats.errorRate.toFixed(2) + '%';
            document.getElementById('totalAmount').textContent = formatCurrency(stats.totalAmount);
            
            updateChart('errorTypesChart', 'doughnut', {
                labels: Object.keys(stats.errorTypes).map(key => ERROR_TYPES[key] || key),
                datasets: [{ data: Object.values(stats.errorTypes), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'] }]
            }, 'Phân bố loại lỗi');

            const sortedTimeline = Object.entries(stats.timeline).sort(([a], [b]) => a.localeCompare(b));
            updateChart('timelineChart', 'line', {
                labels: sortedTimeline.map(([month]) => `${month.substring(4,6)}/${month.substring(0,4)}`),
                datasets: [{ label: 'Số hồ sơ', data: sortedTimeline.map(([, count]) => count), borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', fill: true, tension: 0.4 }]
            }, 'Xu hướng theo thời gian');

            const sortedDepartments = Object.entries(stats.departments).sort(([,a], [,b]) => b - a).slice(0, 10);
            updateChart('departmentChart', 'bar', {
                labels: sortedDepartments.map(([name]) => name || 'Không xác định'),
                datasets: [{ label: 'Số hồ sơ', data: sortedDepartments.map(([, count]) => count), backgroundColor: 'rgba(75, 192, 192, 0.8)' }]
            }, 'Top 10 Khoa có nhiều hồ sơ nhất');
            
            updateChart('amountChart', 'bar', {
                labels: Object.keys(stats.amounts),
                datasets: [{ label: 'Số hồ sơ', data: Object.values(stats.amounts), backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545', '#6f42c1']}]
            }, 'Phân bố chi phí');
        }

        function calculateGlobalStats(records) {
            const totalRecords = records.length;
            if (totalRecords === 0) {
                 return { totalRecords: 0, errorRecordsCount: 0, errorRate: 0, totalAmount: 0, errorTypes: {}, timeline: {}, departments: {}, amounts: {} };
            }

            const errorRecordsCount = records.filter(r => r.errors && r.errors.length > 0).length;
            const errorRate = (errorRecordsCount / totalRecords) * 100;
            
            const stats = {
                totalRecords,
                errorRecordsCount,
                errorRate,
                totalAmount: 0,
                errorTypes: {},
                timeline: {},
                departments: {},
                amounts: { '< 1tr': 0, '1-5tr': 0, '5-10tr': 0, '10-50tr': 0, '> 50tr': 0 }
            };

            records.forEach(r => {
                stats.totalAmount += r.tongChi || 0;
                if (r.errors) r.errors.forEach(err => { stats.errorTypes[err.type] = (stats.errorTypes[err.type] || 0) + 1; });
                if (r.ngayVao) {
                    const month = String(r.ngayVao).substring(0, 6);
                    stats.timeline[month] = (stats.timeline[month] || 0) + 1;
                }
                if(r.maKhoa) stats.departments[r.maKhoa] = (stats.departments[r.maKhoa] || 0) + 1;

                const cost = r.tongChi || 0;
                if (cost < 1000000) stats.amounts['< 1tr']++;
                else if (cost <= 5000000) stats.amounts['1-5tr']++;
                else if (cost <= 10000000) stats.amounts['5-10tr']++;
                else if (cost <= 50000000) stats.amounts['10-50tr']++;
                else stats.amounts['> 50tr']++;
            });
            
            return stats;
        }

        function updateChart(canvasId, type, data, titleText) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (globalData.charts[canvasId]) globalData.charts[canvasId].destroy();
            
            globalData.charts[canvasId] = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: titleText, font: {size: 16} },
                        legend: { position: type === 'doughnut' ? 'bottom' : 'top', display: (data.datasets[0].label || type === 'doughnut') ? true : false }
                    },
                    scales: (type === 'bar' || type === 'line') ? { y: { beginAtZero: true } } : {}
                }
            });
        }
        
        // ============================= VALIDATOR FUNCTIONALITY =============================
        function initializeValidator() {
            const fileInput = document.getElementById('validatorFileInput');
            const uploadArea = document.getElementById('validatorUploadArea');
            
            fileInput.addEventListener('change', (e) => handleFileUpload(e, 'validator'));
            document.getElementById('validatorProcessButton').addEventListener('click', processXmlFile);
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (eventName === 'dragover') uploadArea.classList.add('drag-over');
                    if (eventName === 'dragleave' || eventName === 'drop') uploadArea.classList.remove('drag-over');
                    if (eventName === 'drop' && e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        handleFileUpload({ target: { files: e.dataTransfer.files } }, 'validator');
                    }
                });
            });
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            if (type === 'validator' || type === 'xml') {
                if (!file.name.toLowerCase().endsWith('.xml')) {
                    alert('Vui lòng chọn file có định dạng .xml!');
                    event.target.value = '';
                    return;
                }
            }

            const fileInfoDiv = document.getElementById(type === 'validator' ? 'validatorFileInfo' : (type === 'xml' ? 'xmlStatus' : 'excelStatus'));
            const processButton = document.getElementById(type === 'validator' ? 'validatorProcessButton' : 'compareButton');
            
            fileInfoDiv.innerHTML = `<strong>File:</strong> ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
            fileInfoDiv.style.display = 'block';

            if (type === 'validator') {
                 processButton.disabled = false;
            } else {
                if (type === 'xml') globalData.xmlFile = file;
                if (type === 'excel') globalData.excelFile = file;
                document.getElementById('compareButton').disabled = !(globalData.xmlFile && globalData.excelFile);
            }
        }

        function processXmlFile() {
            const file = document.getElementById('validatorFileInput').files[0];
            if (!file) return alert('Vui lòng chọn file XML!');
            
            showLoading('validatorLoading');
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    globalData.xmlDataContent = e.target.result;
                    setTimeout(() => {
                        const results = validateXmlContent(globalData.xmlDataContent);
                        globalData.allRecords = results;
                        globalData.filteredRecords = results;
                        
                        displayValidatorResults();
                        hideLoading('validatorLoading');
                        
                        document.getElementById('validatorFilters').style.display = 'block';
                        document.getElementById('validatorResults').style.display = 'block';
                        
                        updateDashboard();
                    }, 100);
                } catch (error) {
                    hideLoading('validatorLoading');
                    alert('Lỗi xử lý file: ' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function validateXmlContent(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
            if (xmlDoc.querySelector('parsererror')) throw new Error('File XML không hợp lệ.');

            const results = [];
            const hosoElements = xmlDoc.getElementsByTagName('HOSO');
            for (let hoso of hosoElements) {
                const result = validateSingleHoso(hoso);
                if (result) results.push(result);
            }
            return results;
        }
        
        function validateSingleHoso(hoso) {
            let tongHop = null, chiTietThuoc = null, chiTietDvkt = null;
            hoso.querySelectorAll('FILEHOSO').forEach(fileHoso => {
                const loai = fileHoso.querySelector('LOAIHOSO')?.textContent.trim();
                const noiDung = fileHoso.querySelector('NOIDUNGFILE');
                if (loai === 'XML1') tongHop = noiDung?.querySelector('TONG_HOP');
                if (loai === 'XML2') chiTietThuoc = noiDung;
                if (loai === 'XML3') chiTietDvkt = noiDung;
            });
            if (!tongHop) return null;

            const getText = (element, selector) => element?.querySelector(selector)?.textContent.trim() || '';

            // *** LOGIC CẬP NHẬT TÍNH TỔNG CHI THEO YÊU CẦU MỚI ***
            // 1. Lấy chi phí và tỷ lệ từ XML1
            let costXml1 = parseFloat(getText(tongHop, 'T_TONGCHI_BH') || '0');
            let tyle_tt_bh = parseFloat(getText(tongHop, 'TYLE_TT_BH') || '1');
            if (tyle_tt_bh > 1) { // Chuẩn hóa tỷ lệ nếu ở dạng phần trăm (vd: 80, 95, 100)
                tyle_tt_bh = tyle_tt_bh / 100;
            }

            // 2. Lấy chi phí thô từ XML2
            let costXml2_raw = 0;
            if (chiTietThuoc) {
                const tongHopXml2 = chiTietThuoc.querySelector('tong_hop');
                if (tongHopXml2) {
                    costXml2_raw = parseFloat(getText(tongHopXml2, 'T_BHTT') || '0');
                }
            }

            // 3. Lấy chi phí thô từ XML3
            let costXml3_raw = 0;
            if (chiTietDvkt) {
                const tongHopXml3 = chiTietDvkt.querySelector('tong_hop');
                 if (tongHopXml3) {
                    let thanhTien = getText(tongHopXml3, 'THANH_TIEN_BH');
                    if (!thanhTien) { // Dự phòng nếu không có THANH_TIEN_BH thì tìm T_BHTT
                        thanhTien = getText(tongHopXml3, 'T_BHTT');
                    }
                    costXml3_raw = parseFloat(thanhTien || '0');
                 }
            }

            // 4. Tính tổng chi phí cuối cùng theo công thức yêu cầu
            const finalTongChi = costXml1 + (costXml2_raw * tyle_tt_bh) + (costXml3_raw * tyle_tt_bh);

            const record = {
                maLk: getText(tongHop,'MA_LK'), 
                hoTen: getText(tongHop,'HO_TEN'), 
                ngayVao: getText(tongHop,'NGAY_VAO'),
                ngayRa: getText(tongHop,'NGAY_RA'), 
                maBn: getText(tongHop,'MA_BN'), 
                maThe: getText(tongHop,'MA_THE_BHYT'),
                tongChi: finalTongChi, // Sử dụng giá trị tổng đã tính
                gioiTinh: getText(tongHop,'GIOI_TINH'),
                ngaySinh: getText(tongHop,'NGAY_SINH'), 
                chanDoan: getText(tongHop,'CHAN_DOAN_RV'),
                maKhoa: getText(tongHop,'MA_KHOA'), 
                errors: []
            };
            if (!record.maLk || !record.hoTen || !record.ngayVao || !record.ngayRa) return null;

            if (chiTietThuoc) {
                chiTietThuoc.querySelectorAll('CHI_TIET_THUOC').forEach(item => {
                    const ngayYl = item.querySelector('NGAY_YL')?.textContent.trim();
                    if (ngayYl && ngayYl > record.ngayRa) record.errors.push({ type: 'NGAY_YL_THUOC_SAU_RA_VIEN', severity: 'critical', message: `Thuốc "${item.querySelector('TEN_THUOC')?.textContent.trim()}": YL sau ngày ra.` });
                    if (ngayYl && ngayYl < record.ngayVao) record.errors.push({ type: 'NGAY_YL_THUOC_NGOAI_KHOANG', severity: 'warning', message: `Thuốc "${item.querySelector('TEN_THUOC')?.textContent.trim()}": YL trước ngày vào.` });
                });
            }
            if (chiTietDvkt) {
                chiTietDvkt.querySelectorAll('CHI_TIET_DVKT').forEach(item => {
                    const ngayYl = item.querySelector('NGAY_YL')?.textContent.trim();
                    if (ngayYl && ngayYl > record.ngayRa) record.errors.push({ type: 'NGAY_YL_DVKT_SAU_RA_VIEN', severity: 'critical', message: `Dịch vụ "${item.querySelector('TEN_DICH_VU')?.textContent.trim()}": YL sau ngày ra.` });
                    if (ngayYl && ngayYl < record.ngayVao) record.errors.push({ type: 'NGAY_YL_DVKT_NGOAI_KHOANG', severity: 'warning', message: `Dịch vụ "${item.querySelector('TEN_DICH_VU')?.textContent.trim()}": YL trước ngày vào.` });
                });
            }
            if (record.ngayVao > record.ngayRa) record.errors.push({ type: 'NGAY_VAO_SAU_NGAY_RA', severity: 'critical', message: `Ngày vào sau ngày ra.` });
            
            return record;
        }

        function displayValidatorResults() {
            updateErrorTypeFilter();
            applyFilters();
        }

        function updateErrorTypeFilter() {
            const errorTypeFilter = document.getElementById('errorTypeFilter');
            const errorTypes = new Set(globalData.allRecords.flatMap(r => r.errors.map(e => e.type)));
            errorTypeFilter.innerHTML = '<option value="">Tất cả loại lỗi</option>';
            errorTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = ERROR_TYPES[type] || type;
                errorTypeFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const filters = {
                errorType: document.getElementById('errorTypeFilter').value,
                severity: document.getElementById('severityFilter').value,
                searchText: document.getElementById('searchBox').value.toLowerCase(),
                dateFrom: document.getElementById('dateFromFilter').value.replace(/-/g, ''),
                dateTo: document.getElementById('dateToFilter').value.replace(/-/g, ''),
                amountFrom: parseFloat(document.getElementById('amountFromFilter').value),
                amountTo: parseFloat(document.getElementById('amountToFilter').value),
                gender: document.getElementById('genderFilter').value
            };

            globalData.filteredRecords = globalData.allRecords.filter(r => {
                if (filters.errorType && !r.errors.some(e => e.type === filters.errorType)) return false;
                if (filters.severity) {
                    if (filters.severity === 'success' && r.errors.length > 0) return false;
                    if (filters.severity === 'critical' && !r.errors.some(e => e.severity === 'critical')) return false;
                    if (filters.severity === 'warning' && (!r.errors.some(e => e.severity === 'warning') || r.errors.some(e => e.severity === 'critical'))) return false;
                }
                if (filters.searchText && !`${r.hoTen} ${r.maLk} ${r.maBn}`.toLowerCase().includes(filters.searchText)) return false;
                const recordDate = String(r.ngayVao).substring(0, 8);
                if (filters.dateFrom && recordDate < filters.dateFrom) return false;
                if (filters.dateTo && recordDate > filters.dateTo) return false;
                if (!isNaN(filters.amountFrom) && r.tongChi < filters.amountFrom) return false;
                if (!isNaN(filters.amountTo) && r.tongChi > filters.amountTo) return false;
                if (filters.gender && r.gioiTinh !== filters.gender) return false;
                return true;
            });
            
            globalData.currentPage = 1;
            updateResultsTable();
        }

        function updateResultsTable() {
            const tbody = document.getElementById('resultsTableBody');
            const startIndex = (globalData.currentPage - 1) * globalData.pageSize;
            const pageRecords = globalData.filteredRecords.slice(startIndex, startIndex + globalData.pageSize);
            
            tbody.innerHTML = '';
            pageRecords.forEach((record, index) => {
                const row = tbody.insertRow();
                let statusClass = 'status-success', statusText = '🟢 Hợp lệ';
                if (record.errors.length > 0) {
                    const isCritical = record.errors.some(e => e.severity === 'critical');
                    statusClass = isCritical ? 'status-error' : 'status-warning';
                    statusText = isCritical ? `🔴 Có ${record.errors.length} lỗi` : `🟡 Có ${record.errors.length} cảnh báo`;
                }

                const errorDetails = record.errors.map(e => `<div class="error-detail"><span class="status-badge ${e.severity === 'critical' ? 'status-error' : 'status-warning'}">${ERROR_TYPES[e.type] || e.type}</span> <small>${e.message}</small></div>`).join('');
                
                row.innerHTML = `
                    <td>${startIndex + index + 1}</td>
                    <td><strong>${record.hoTen}</strong><br><small>LK: ${record.maLk}</small>${record.maBn ? `<br><small>BN: ${record.maBn}</small>` : ''}</td>
                    <td><strong>Vào:</strong> ${formatDateTimeForDisplay(record.ngayVao)}<br><strong>Ra:</strong> ${formatDateTimeForDisplay(record.ngayRa)}</td>
                    <td>${formatCurrency(record.tongChi)}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${errorDetails || '<span class="status-badge status-success">Không có lỗi</span>'}</td>
                `;
            });
            
            updatePagination();
            updateResultsInfo();
        }

        function updatePagination() {
            const container = document.getElementById('paginationContainer');
            const totalPages = Math.ceil(globalData.filteredRecords.length / globalData.pageSize);
            if (totalPages <= 1) { container.innerHTML = ''; return; }

            container.innerHTML = `
                <button onclick="changePage(1)" ${globalData.currentPage === 1 ? 'disabled' : ''}>« Đầu</button>
                <button onclick="changePage(${globalData.currentPage - 1})" ${globalData.currentPage === 1 ? 'disabled' : ''}>‹ Trước</button>
                <span class="page-info">Trang ${globalData.currentPage} / ${totalPages}</span>
                <button onclick="changePage(${globalData.currentPage + 1})" ${globalData.currentPage === totalPages ? 'disabled' : ''}>Tiếp ›</button>
                <button onclick="changePage(${totalPages})" ${globalData.currentPage === totalPages ? 'disabled' : ''}>Cuối »</button>
            `;
        }
        
        function changePage(page) {
            globalData.currentPage = page;
            updateResultsTable();
        }
        
        function updateResultsInfo() {
            const info = document.getElementById('resultsInfo');
            const total = globalData.filteredRecords.length;
            const start = total > 0 ? (globalData.currentPage - 1) * globalData.pageSize + 1 : 0;
            const end = Math.min(globalData.currentPage * globalData.pageSize, total);
            info.textContent = `Hiển thị ${start}-${end} trong tổng số ${total.toLocaleString('vi-VN')} kết quả`;
        }

        function clearFilters() {
            document.getElementById('validatorFilters').querySelectorAll('input, select').forEach(el => {
                if (el.type !== 'button') el.value = '';
            });
            applyFilters();
        }

        function exportToExcel(errorsOnly = false) {
            const recordsToExport = errorsOnly 
                ? globalData.filteredRecords.filter(r => r.errors.length > 0)
                : globalData.filteredRecords;

            if (recordsToExport.length === 0) return alert('Không có dữ liệu để xuất!');
            
            const wb = XLSX.utils.book_new();
            
            const stats = calculateGlobalStats(recordsToExport);
            const summaryData = [
                ['BÁO CÁO KIỂM TRA FILE XML BHYT'],
                ['Thời gian tạo:', new Date().toLocaleString('vi-VN')], [],
                ['THỐNG KÊ TỔNG QUAN'],
                ['Tổng hồ sơ đã lọc:', recordsToExport.length],
                ['Tổng chi phí:', stats.totalAmount],
                ['Tỷ lệ lỗi:', `${stats.errorRate.toFixed(2)}%`], [],
                ['PHÂN BỐ LỖI'],
                ['Loại lỗi', 'Số lượng']
            ];
            Object.entries(stats.errorTypes).forEach(([type, count]) => {
                summaryData.push([ERROR_TYPES[type] || type, count]);
            });
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Tong_Quan');

            const data = recordsToExport.map((r, i) => ({
                'STT': i + 1, 'Họ Tên': r.hoTen, 'Mã LK': r.maLk, 'Mã BN': r.maBn,
                'Ngày Vào': formatDateTimeForDisplay(r.ngayVao), 'Ngày Ra': formatDateTimeForDisplay(r.ngayRa),
                'Tổng Chi Phí': r.tongChi,
                'Trạng Thái': r.errors.length > 0 ? (r.errors.some(e => e.severity === 'critical') ? 'Lỗi nghiêm trọng' : 'Cảnh báo') : 'Hợp lệ',
                'Chi Tiết Lỗi': r.errors.map(e => `${ERROR_TYPES[e.type] || e.type}: ${e.message}`).join('\n')
            }));
            const wsData = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, wsData, 'Chi_Tiet');

            XLSX.writeFile(wb, errorsOnly ? 'BaoCaoLoi_BHYT.xlsx' : 'BaoCaoKiemTra_BHYT.xlsx');
        }
        
        // ============================= COMPARATOR FUNCTIONALITY (UPGRADED) =============================
        function initializeComparator() {
            document.getElementById('comparatorXmlInput').addEventListener('change', (e) => handleFileUpload(e, 'xml'));
            document.getElementById('comparatorExcelInput').addEventListener('change', (e) => handleFileUpload(e, 'excel'));
            document.getElementById('compareButton').addEventListener('click', performComparison);
        }

        function findKey(obj, possibleKeys) {
            const upperKeys = possibleKeys.map(k => k.toUpperCase().replace(/ /g, ''));
            for (const key in obj) {
                if (upperKeys.includes(key.trim().toUpperCase().replace(/ /g, ''))) {
                    return key;
                }
            }
            return null;
        }

        async function performComparison() {
            showLoading('comparatorLoading');
            try {
                // 1. Read XML File
                const xmlContent = await globalData.xmlFile.text();
                const xmlRecordsRaw = validateXmlContent(xmlContent);
                globalData.xmlRecords.clear();
                xmlRecordsRaw.forEach(r => globalData.xmlRecords.set(r.maLk, r));

                // 2. Read Excel/CSV File
                globalData.excelRecords.clear();
                const file = globalData.excelFile;
                const isCSV = file.name.toLowerCase().endsWith('.csv');

                let excelJson;
                if (isCSV) {
                    const text = await file.text();
                    const workbook = XLSX.read(text, {type: 'string'});
                    const sheetName = workbook.SheetNames[0];
                    excelJson = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                } else {
                    const excelBuffer = await file.arrayBuffer();
                    const workbook = XLSX.read(excelBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    excelJson = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                }

                excelJson.forEach(row => {
                    const maLkKey = findKey(row, ['MA_LK', 'MÃ LK', 'MÃ LIÊN KẾT']);
                    if(maLkKey && row[maLkKey]) {
                        globalData.excelRecords.set(String(row[maLkKey]), row);
                    }
                });
                
                // 3. Compare Data
                const allKeys = new Set([...globalData.xmlRecords.keys(), ...globalData.excelRecords.keys()]);
                globalData.comparisonResults = [];
                for (const key of allKeys) {
                    const xmlRec = globalData.xmlRecords.get(key);
                    const excelRec = globalData.excelRecords.get(key);
                    
                    let result = { key, xmlRec, excelRec, status: 'mismatch', details: [] };
                    
                    if (xmlRec && excelRec) {
                        const tongChiXml = xmlRec.tongChi || 0;
                        const tongChiExcelKey = findKey(excelRec, ['T_TONGCHI', 'TONG_CHI', 'TỔNG CHI PHÍ', 'T_TONGCHI_BH', 'BẢO HIỂM TT']);
                        const tongChiExcel = tongChiExcelKey ? (parseFloat(excelRec[tongChiExcelKey]) || 0) : 0;
                        
                        if(Math.abs(tongChiXml - tongChiExcel) > 1) { // Allow 1 VND tolerance
                            result.details.push(`Chi phí: XML=${formatCurrency(tongChiXml)} vs Excel=${formatCurrency(tongChiExcel)}`);
                        }
                        
                        const hoTenXml = xmlRec.hoTen.toLowerCase().trim();
                        const hoTenExcelKey = findKey(excelRec, ['HO_TEN', 'HỌ TÊN']);
                        const hoTenExcel = hoTenExcelKey ? String(excelRec[hoTenExcelKey]).toLowerCase().trim() : '';
                        if(hoTenXml !== hoTenExcel) {
                           result.details.push(`Họ Tên: XML="${xmlRec.hoTen}" vs Excel="${excelRec[hoTenExcelKey]}"`);
                        }
                        
                        result.status = result.details.length === 0 ? 'match' : 'mismatch';

                    } else if (xmlRec) {
                        result.status = 'xml-only';
                    } else {
                        result.status = 'excel-only';
                    }
                    globalData.comparisonResults.push(result);
                }
                
                hideLoading('comparatorLoading');
                document.getElementById('comparatorResults').style.display = 'block';
                applyComparatorFilters();

            } catch (error) {
                hideLoading('comparatorLoading');
                console.error("Comparison Error:", error);
                alert(`Lỗi đối chiếu: ${error.message}`);
            }
        }
        
        function applyComparatorFilters() {
            const status = document.getElementById('statusFilter').value;
            const maLk = document.getElementById('maLkSearch').value.toLowerCase();
            const patientName = document.getElementById('patientSearch').value.toLowerCase();

            globalData.filteredComparisonResults = globalData.comparisonResults.filter(r => {
                if (status && r.status !== status) return false;
                if (maLk && !r.key.toLowerCase().includes(maLk)) return false;
                if (patientName) {
                    const xmlName = r.xmlRec?.hoTen?.toLowerCase() || '';
                    const excelHoTenKey = r.excelRec ? findKey(r.excelRec, ['HO_TEN', 'HỌ TÊN']) : null;
                    const excelName = excelHoTenKey ? String(r.excelRec[excelHoTenKey]).toLowerCase() : '';
                    if (!xmlName.includes(patientName) && !excelName.includes(patientName)) return false;
                }
                return true;
            });
            displayComparatorResults();
        }

        function displayComparatorResults() {
            const wrapper = document.getElementById('comparatorResultsTableWrapper');
            const info = document.getElementById('comparatorResultsInfo');
            
            let tableHTML = `<table class="results-table"><thead><tr>
                <th>Mã LK</th>
                <th>Trạng thái</th>
                <th>Thông tin XML</th>
                <th>Thông tin file đối chiếu</th>
                <th>Chi tiết không khớp</th>
            </tr></thead><tbody>`;

            if (globalData.filteredComparisonResults.length === 0) {
                tableHTML += `<tr><td colspan="5" style="text-align:center;">Không tìm thấy kết quả phù hợp.</td></tr>`;
            } else {
                globalData.filteredComparisonResults.forEach(r => {
                    const xmlName = r.xmlRec?.hoTen || 'N/A';
                    const xmlCost = r.xmlRec ? formatCurrency(r.xmlRec.tongChi) : 'N/A';
                    
                    const excelHoTenKey = r.excelRec ? findKey(r.excelRec, ['HO_TEN', 'HỌ TÊN']) : null;
                    const excelName = excelHoTenKey ? r.excelRec[excelHoTenKey] : 'N/A';

                    const excelCostKey = r.excelRec ? findKey(r.excelRec, ['T_TONGCHI', 'TONG_CHI', 'TỔNG CHI PHÍ', 'T_TONGCHI_BH', 'BẢO HIỂM TT']) : null;
                    const excelCost = excelCostKey ? formatCurrency(r.excelRec[excelCostKey]) : 'N/A';
                    
                    const statusMap = {
                        match: { text: '✅ Khớp', class: 'status-match' },
                        mismatch: { text: '❌ Không khớp', class: 'status-mismatch' },
                        'xml-only': { text: '📄 Chỉ có trong XML', class: 'status-xml-only' },
                        'excel-only': { text: '📊 Chỉ có trong file đối chiếu', class: 'status-excel-only' }
                    };
                    
                    const highlightCost = r.status === 'mismatch' ? 'style="color:red; font-weight:bold;"' : '';
                    
                    let detailsHtml = '';
                    if (r.details && r.details.length > 0) {
                        detailsHtml = `<div class="comparator-details"><ul><li>${r.details.join('</li><li>')}</li></ul></div>`;
                    }

                    tableHTML += `
                        <tr class="${r.status}">
                            <td>${r.key}</td>
                            <td><span class="status-badge ${statusMap[r.status].class}">${statusMap[r.status].text}</span></td>
                            <td><strong>${xmlName}</strong><br><span ${highlightCost}>${xmlCost}</span></td>
                            <td><strong>${excelName}</strong><br><span ${highlightCost}>${excelCost}</span></td>
                            <td>${detailsHtml}</td>
                        </tr>
                    `;
                });
            }

            tableHTML += '</tbody></table>';
            wrapper.innerHTML = tableHTML;
            info.textContent = `Tìm thấy ${globalData.filteredComparisonResults.length.toLocaleString('vi-VN')} kết quả.`;
        }
        
        function clearComparatorFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('maLkSearch').value = '';
            document.getElementById('patientSearch').value = '';
            applyComparatorFilters();
        }

        function exportComparatorResults() {
            if (globalData.filteredComparisonResults.length === 0) return alert('Không có dữ liệu để xuất!');
            
            const data = globalData.filteredComparisonResults.map(r => {
                 const excelHoTenKey = r.excelRec ? findKey(r.excelRec, ['HO_TEN', 'HỌ TÊN']) : null;
                 const excelCostKey = r.excelRec ? findKey(r.excelRec, ['T_TONGCHI', 'TONG_CHI', 'TỔNG CHI PHÍ', 'T_TONGCHI_BH', 'BẢO HIỂM TT']) : null;
                 return {
                    'Mã LK': r.key,
                    'Trạng thái': r.status,
                    'Tên BN (XML)': r.xmlRec?.hoTen,
                    'Chi phí (XML)': r.xmlRec?.tongChi,
                    'Tên BN (File đối chiếu)': excelHoTenKey ? r.excelRec[excelHoTenKey] : null,
                    'Chi phí (File đối chiếu)': excelCostKey ? r.excelRec[excelCostKey] : null,
                    'Chi tiết không khớp': r.details ? r.details.join('; ') : ''
                 };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KetQuaDoiChieu");
            XLSX.writeFile(wb, "BaoCaoDoiChieu_BHYT.xlsx");
        }

        // ============================= REPORTS TAB =============================
        function generateReport() {
            if (globalData.allRecords.length === 0) {
                alert('Chưa có dữ liệu. Vui lòng kiểm tra một file XML trước.');
                return;
            }

            const reportType = document.getElementById('reportType').value;
            const dateFrom = document.getElementById('reportDateFrom').value.replace(/-/g, '');
            const dateTo = document.getElementById('reportDateTo').value.replace(/-/g, '');

            const filteredForReport = globalData.allRecords.filter(r => {
                if (!dateFrom && !dateTo) return true;
                const recordDate = String(r.ngayVao).substring(0, 8);
                if (dateFrom && recordDate < dateFrom) return false;
                if (dateTo && recordDate > dateTo) return false;
                return true;
            });
            
            const stats = calculateGlobalStats(filteredForReport);
            let chart1Type, chart1Data, chart1Title;
            let chart2Type, chart2Data, chart2Title;

            switch(reportType) {
                case 'error-summary':
                    const sortedErrors = Object.entries(stats.errorTypes).sort(([, a], [, b]) => b - a);
                    chart1Type = 'bar';
                    chart1Data = {
                        labels: sortedErrors.map(([key]) => ERROR_TYPES[key] || key),
                        datasets: [{ label: 'Số Lần Xuất Hiện', data: sortedErrors.map(([, count]) => count), backgroundColor: 'rgba(220, 53, 69, 0.8)' }]
                    };
                    chart1Title = 'Thống Kê Các Loại Lỗi Phổ Biến';

                    chart2Type = 'doughnut';
                    chart2Data = {
                        labels: ['Hồ Sơ Hợp Lệ', 'Hồ Sơ Có Lỗi'],
                        datasets: [{ data: [stats.totalRecords - stats.errorRecordsCount, stats.errorRecordsCount], backgroundColor: ['#28a745', '#dc3545'] }]
                    };
                    chart2Title = 'Tỷ Lệ Hồ Sơ Lỗi và Hợp Lệ';
                    break;
                case 'time-analysis':
                    const sortedTimeline = Object.entries(stats.timeline).sort(([a], [b]) => a.localeCompare(b));
                    chart1Type = 'line';
                    chart1Data = {
                        labels: sortedTimeline.map(([month]) => `${month.substring(4,6)}/${month.substring(0,4)}`),
                        datasets: [{ label: 'Số Hồ Sơ', data: sortedTimeline.map(([, count]) => count), borderColor: '#667eea', tension: 0.1 }]
                    };
                    chart1Title = 'Phân Tích Số Lượng Hồ Sơ Theo Thời Gian';

                    const errorTimeline = {};
                    filteredForReport.forEach(r => {
                        if (r.errors.length > 0) {
                            const month = String(r.ngayVao).substring(0, 6);
                            errorTimeline[month] = (errorTimeline[month] || 0) + 1;
                        }
                    });
                    const filledErrorTimelineData = sortedTimeline.map(([month]) => errorTimeline[month] || 0);
                    chart2Type = 'line';
                    chart2Data = {
                        labels: sortedTimeline.map(([month]) => `${month.substring(4,6)}/${month.substring(0,4)}`),
                        datasets: [{ label: 'Số Hồ Sơ Lỗi', data: filledErrorTimelineData, borderColor: '#dc3545', tension: 0.1 }]
                    };
                    chart2Title = 'Phân Tích Số Lượng Lỗi Theo Thời Gian';
                    break;
                case 'cost-analysis':
                    chart1Type = 'bar';
                    chart1Data = {
                        labels: Object.keys(stats.amounts),
                        datasets: [{ label: 'Số Hồ Sơ', data: Object.values(stats.amounts), backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#dc3545', '#6f42c1'] }]
                    };
                    chart1Title = 'Phân Bố Hồ Sơ Theo Khoảng Chi Phí';

                     const costByMonth = {};
                     filteredForReport.forEach(r => {
                         const month = String(r.ngayVao).substring(0, 6);
                         costByMonth[month] = (costByMonth[month] || 0) + r.tongChi;
                     });
                    const sortedCostByMonth = Object.entries(costByMonth).sort(([a], [b]) => a.localeCompare(b));
                    chart2Type = 'bar';
                    chart2Data = {
                         labels: sortedCostByMonth.map(([month]) => `${month.substring(4,6)}/${month.substring(0,4)}`),
                        datasets: [{ label: 'Tổng Chi Phí (VNĐ)', data: sortedCostByMonth.map(([, cost]) => cost), backgroundColor: 'rgba(54, 162, 235, 0.8)' }]
                    };
                    chart2Title = 'Tổng Chi Phí Theo Thời Gian';
                    break;
                case 'department-analysis':
                    const sortedDepts = Object.entries(stats.departments).sort(([, a], [, b]) => b - a).slice(0, 15);
                    chart1Type = 'bar';
                    chart1Data = {
                        labels: sortedDepts.map(([name]) => name || 'Không xác định'),
                        datasets: [{ label: 'Số Hồ Sơ', data: sortedDepts.map(([, count]) => count), backgroundColor: 'rgba(75, 192, 192, 0.8)'}]
                    };
                    chart1Title = 'Top 15 Khoa Theo Số Lượng Hồ Sơ';

                    const costByDept = {};
                    filteredForReport.forEach(r => {
                        costByDept[r.maKhoa] = (costByDept[r.maKhoa] || 0) + r.tongChi;
                    });
                    const sortedCostDepts = sortedDepts.map(([name]) => ({
                        name: name || 'Không xác định',
                        cost: costByDept[name] || 0
                    }));
                     chart2Type = 'bar';
                     chart2Data = {
                        labels: sortedCostDepts.map(d => d.name),
                        datasets: [{ label: 'Tổng Chi Phí (VNĐ)', data: sortedCostDepts.map(d => d.cost), backgroundColor: 'rgba(153, 102, 255, 0.8)' }]
                     };
                     chart2Title = 'Top 15 Khoa Theo Tổng Chi Phí';
                    break;
            }
            updateChart('reportChart1', chart1Type, chart1Data, chart1Title);
            updateChart('reportChart2', chart2Type, chart2Data, chart2Title);
        }

        function exportReport() {
            alert('Chức năng xuất báo cáo chuyên sâu đang được phát triển. Vui lòng sử dụng chức năng "Xuất Excel" ở tab Kiểm tra XML.');
        }

        // ============================= INITIALIZATION =============================
        document.addEventListener('DOMContentLoaded', () => {
            initializeValidator();
            initializeComparator();
            
            document.querySelectorAll('.filter-content').forEach(el => {
                const parent = el.parentElement;
                const toggleButton = parent.querySelector('.filter-toggle');
                if (toggleButton) {
                     el.style.display = 'none';
                    if(parent.querySelector('.filter-actions')) parent.querySelector('.filter-actions').style.display = 'none';
                    toggleButton.textContent = 'Mở rộng';
                }
            });

            Object.keys(globalData.charts).forEach(key => {
                if(globalData.charts[key] && typeof globalData.charts[key].destroy === 'function') {
                    globalData.charts[key].destroy();
                }
            });
            updateChart('errorTypesChart', 'doughnut', {labels:[], datasets:[{data:[]}]}, 'Phân bố loại lỗi (chưa có dữ liệu)');
            updateChart('timelineChart', 'line', {labels:[], datasets:[{data:[]}]}, 'Xu hướng theo thời gian (chưa có dữ liệu)');
            updateChart('departmentChart', 'bar', {labels:[], datasets:[{data:[]}]}, 'Phân bố theo khoa (chưa có dữ liệu)');
            updateChart('amountChart', 'bar', {labels:[], datasets:[{data:[]}]}, 'Phân bố chi phí (chưa có dữ liệu)');
            updateChart('reportChart1', 'bar', {labels:[], datasets:[{data:[]}]}, 'Báo cáo 1 (chưa có dữ liệu)');
            updateChart('reportChart2', 'bar', {labels:[], datasets:[{data:[]}]}, 'Báo cáo 2 (chưa có dữ liệu)');
        });

    </script>
</body>
</html>
