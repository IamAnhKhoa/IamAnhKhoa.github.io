<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tra c·ª©u c·∫≠p nh·∫≠t h·ªá th·ªëng Tr·∫°m Y t·∫ø - C·ªß Chi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    :root {
      --primary: #0d6efd;
      --success: #198754;
      --info: #0dcaf0;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #212529;
    }
    
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    
    .header-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 1rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-bottom: 1.5rem;
      border: none;
    }
    
    .logo-wrapper {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary), var(--info));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }
    
    .logo-wrapper img {
      width: 32px;
      height: 32px;
      filter: brightness(0) invert(1);
    }
    
    .search-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: none;
      transition: all 0.3s ease;
    }
    
    .search-card:hover {
      box-shadow: 0 12px 48px rgba(0,0,0,0.12);
    }
    
    .form-control {
      border-radius: 0.75rem;
      border: 2px solid #e9ecef;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }
    
    .btn {
      border-radius: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #0a58ca);
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(13, 110, 253, 0.4);
    }
    
    .btn-outline-secondary, .btn-outline-success {
      border: 2px solid;
      background: white;
    }
    
    .btn-outline-secondary:hover, .btn-outline-success:hover {
      transform: translateY(-2px);
    }
    
    .result-card {
      background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
      border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      border: none;
      animation: slideIn 0.4s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .table-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      overflow: hidden;
      border: none;
    }
    
    .table {
      margin-bottom: 0;
    }
    
    .table thead th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 1rem;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      cursor: pointer;
      user-select: none;
    }
    
    .table thead th:hover {
      background: linear-gradient(135deg, #5568d3 0%, #653a8e 100%);
    }
    
    .table tbody tr {
      transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
      background: #f8f9fa;
      transform: scale(1.01);
    }
    
    .badge {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .stat-box {
      background: white;
      border-radius: 0.75rem;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--info));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .filter-bar {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
      .main-container { padding: 1rem; }
      .header-card { padding: 1.5rem; }
      .search-card { padding: 1rem; }
      .stat-number { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <div class="header-card">
      <div class="d-flex align-items-center gap-3">
        <div class="logo-wrapper">
          <img alt="Logo" src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3e5.svg"/>
        </div>
        <div class="flex-grow-1">
          <h1 class="h3 mb-1 fw-bold">C·∫≠p nh·∫≠t h·ªá th·ªëng Tr·∫°m Y t·∫ø ‚Äì C·ªß Chi</h1>
          <p class="text-muted mb-0 small">Tra c·ª©u ƒë·ªëi chi·∫øu t·ª´ <strong>21 Tr·∫°m c≈©</strong> ‚Üí <strong>7 Tr·∫°m m·ªõi</strong> + <strong>14 ƒêi·ªÉm y t·∫ø</strong></p>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-number">21</div>
        <div class="text-muted small">Tr·∫°m c≈©</div>
      </div>
      <div class="stat-box">
        <div class="stat-number">7</div>
        <div class="text-muted small">Tr·∫°m m·ªõi</div>
      </div>
      <div class="stat-box">
        <div class="stat-number">14</div>
        <div class="text-muted small">ƒêi·ªÉm y t·∫ø</div>
      </div>
    </div>

    <!-- Search -->
    <div class="search-card">
      <div class="row g-3">
        <div class="col-lg-8">
          <label for="oldInput" class="form-label fw-semibold">T√¨m ki·∫øm Tr·∫°m Y t·∫ø c≈©</label>
          <input list="oldList" class="form-control" id="oldInput" placeholder="Nh·∫≠p t√™n tr·∫°m (VD: Ph∆∞·ªõc Hi·ªáp, C·ªß Chi...)" autocomplete="off">
          <datalist id="oldList"></datalist>
          <div class="form-text">G√µ kh√¥ng d·∫•u c≈©ng ƒë∆∞·ª£c ‚Ä¢ Enter ƒë·ªÉ t√¨m</div>
        </div>
        <div class="col-lg-4 d-flex align-items-end gap-2">
          <button id="btnLookup" class="btn btn-primary flex-fill">
            <span class="btn-text">Tra c·ª©u</span>
          </button>
          <button id="btnClear" class="btn btn-outline-secondary">X√≥a</button>
        </div>
      </div>
    </div>

    <!-- Result -->
    <div id="result"></div>

    <!-- Table -->
    <div class="table-card">
      <div class="filter-bar">
        <div class="row g-2 align-items-center">
          <div class="col-md-8">
            <input id="filterInput" class="form-control" placeholder="üîç L·ªçc nhanh theo t√™n..." />
          </div>
          <div class="col-md-4 text-md-end">
            <button id="btnExport" class="btn btn-outline-success w-100 w-md-auto">
              üì• Xu·∫•t CSV
            </button>
          </div>
        </div>
      </div>
      <div class="table-responsive">
        <table id="mapTable" class="table table-hover align-middle">
          <thead>
            <tr>
              <th data-key="old">Tr·∫°m c≈© ‚Üï</th>
              <th data-key="newStation">Tr·∫°m m·ªõi ‚Üï</th>
              <th data-key="newPoint">ƒêi·ªÉm y t·∫ø ‚Üï</th>
              <th style="width:100px">Thao t√°c</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="mt-4 p-3 bg-white rounded-3 shadow-sm">
      <p class="small text-muted mb-0">
        <strong>üìã Ghi ch√∫:</strong> D·ªØ li·ªáu ƒë∆∞·ª£c bi√™n so·∫°n theo Quy·∫øt ƒë·ªãnh c·ªßa UBND TP.HCM v·ªÅ vi·ªác t·ªï ch·ª©c l·∫°i h·ªá th·ªëng Tr·∫°m Y t·∫ø thu·ªôc Trung t√¢m Y t·∫ø khu v·ª±c C·ªß Chi (2025).
      </p>
    </div>
  </div>

  <script>
    // Optimized data structure with pre-computed normalized fields
    const mappings = [
      { old: 'Tr·∫°m Y t·∫ø x√£ T√¢n An H·ªôi', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ T√¢n An H·ªôi', newPoint: '', newAddr: 'ƒê∆∞·ªùng L√™ Minh Nh·ª±t, x√£ T√¢n An H·ªôi, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø th·ªã tr·∫•n C·ªß Chi', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ T√¢n An H·ªôi', newPoint: 'ƒêi·ªÉm y t·∫ø 1', newAddr: 'S·ªë 3 ƒë∆∞·ªùng Ph·∫°m H·ªØu T√¢m, x√£ T√¢n An H·ªôi, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Ph∆∞·ªõc Hi·ªáp', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ T√¢n An H·ªôi', newPoint: 'ƒêi·ªÉm y t·∫ø 2', newAddr: 'ƒê∆∞·ªùng Phan VƒÉn Kh·∫£i, x√£ T√¢n An H·ªôi, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ T√¢n Ph√∫ Trung', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ C·ªß Chi', newPoint: '', newAddr: 'ƒê∆∞·ªùng 78, x√£ C·ªß Chi, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Ph∆∞·ªõc Vƒ©nh An', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ C·ªß Chi', newPoint: 'ƒêi·ªÉm y t·∫ø 1', newAddr: 'S·ªë 553 ƒë∆∞·ªùng T·ªânh l·ªô 8, x√£ C·ªß Chi, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ T√¢n Th√¥ng H·ªôi', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ C·ªß Chi', newPoint: 'ƒêi·ªÉm y t·∫ø 2', newAddr: 'S·ªë 347 ƒë∆∞·ªùng Phan VƒÉn Kh·∫£i, x√£ C·ªß Chi, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Ph√∫ H√≤a ƒê√¥ng', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ Ph√∫ H√≤a ƒê√¥ng', newPoint: '', newAddr: 'S·ªë 151 ƒë∆∞·ªùng T·ªânh l·ªô 15, x√£ Ph√∫ H√≤a ƒê√¥ng, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ T√¢n Th·∫°nh T√¢y', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ Ph√∫ H√≤a ƒê√¥ng', newPoint: 'ƒêi·ªÉm y t·∫ø 1', newAddr: 'S·ªë 256 ƒë∆∞·ªùng T·ªânh l·ªô 8, x√£ Ph√∫ H√≤a ƒê√¥ng, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ T√¢n Th·∫°nh ƒê√¥ng', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ Ph√∫ H√≤a ƒê√¥ng', newPoint: 'ƒêi·ªÉm y t·∫ø 2', newAddr: 'ƒê∆∞·ªùng Nguy·ªÖn Th·ªã H·∫£o, x√£ Ph√∫ H√≤a ƒê√¥ng, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Nhu·∫≠n ƒê·ª©c', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ Nhu·∫≠n ƒê·ª©c', newPoint: '', newAddr: 'ƒê∆∞·ªùng Nhu·∫≠n ƒê·ª©c, x√£ Nhu·∫≠n ƒê·ª©c, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Ph·∫°m VƒÉn C·ªôi', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ Nhu·∫≠n ƒê·ª©c', newPoint: 'ƒêi·ªÉm y t·∫ø 1', newAddr: 'S·ªë 76 ƒë∆∞·ªùng Ph·∫°m VƒÉn C·ªôi, x√£ Nhu·∫≠n ƒê·ª©c, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Trung L·∫≠p H·∫°', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ Nhu·∫≠n ƒê·ª©c', newPoint: 'ƒêi·ªÉm y t·∫ø 2', newAddr: 'S·ªë 234 ƒë∆∞·ªùng T·ªânh l·ªô 2, x√£ Nhu·∫≠n ƒê·ª©c, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ An Nh∆°n T√¢y', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ An Nh∆°n T√¢y', newPoint: '', newAddr: 'S·ªë 05 ƒë∆∞·ªùng ƒê·ªó ƒêƒÉng Tuy√™n, x√£ An Nh∆°n T√¢y, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ An Ph√∫', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ An Nh∆°n T√¢y', newPoint: 'ƒêi·ªÉm y t·∫ø 1', newAddr: 'ƒê∆∞·ªùng T·ªânh l·ªô 15, x√£ An Nh∆°n T√¢y, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Ph√∫ M·ªπ H∆∞ng', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ An Nh∆°n T√¢y', newPoint: 'ƒêi·ªÉm y t·∫ø 2', newAddr: 'S·ªë 4 ƒë∆∞·ªùng Ph√∫ Thu·∫≠n, x√£ An Nh∆°n T√¢y, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Th√°i M·ªπ', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ Th√°i M·ªπ', newPoint: '', newAddr: 'S·ªë 394 ƒë∆∞·ªùng T·ªânh l·ªô 7, x√£ Th√°i M·ªπ, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Ph∆∞·ªõc Th·∫°nh', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ Th√°i M·ªπ', newPoint: 'ƒêi·ªÉm y t·∫ø 1', newAddr: 'S·ªë 01 ƒë∆∞·ªùng 642, x√£ Th√°i M·ªπ, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Trung L·∫≠p Th∆∞·ª£ng', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ Th√°i M·ªπ', newPoint: 'ƒêi·ªÉm y t·∫ø 2', newAddr: 'S·ªë 83 ƒë∆∞·ªùng Trung L·∫≠p, x√£ Th√°i M·ªπ, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ B√¨nh M·ªπ', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ B√¨nh M·ªπ', newPoint: '', newAddr: 'S·ªë 80 ƒë∆∞·ªùng H√† Duy Phi√™n, x√£ B√¨nh M·ªπ, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ H√≤a Ph√∫', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ B√¨nh M·ªπ', newPoint: 'ƒêi·ªÉm y t·∫ø 1', newAddr: 'S·ªë 351 ƒë∆∞·ªùng B·∫øn Th·∫°n, x√£ B√¨nh M·ªπ, Th√†nh ph·ªë H·ªì Ch√≠ Minh' },
      { old: 'Tr·∫°m Y t·∫ø x√£ Trung An', oldAddr: '', newStation: 'Tr·∫°m Y t·∫ø x√£ B√¨nh M·ªπ', newPoint: 'ƒêi·ªÉm y t·∫ø 2', newAddr: 'S·ªë 247 ƒë∆∞·ªùng Trung An, x√£ B√¨nh M·ªπ, Th√†nh ph·ªë H·ªì Ch√≠ Minh' }
    ];

    // Optimized normalization - memoized
    const normalize = (() => {
      const cache = new Map();
      return (str) => {
        if (!str) return '';
        if (cache.has(str)) return cache.get(str);
        const normalized = str.normalize('NFD').replace(/\p{Diacritic}/gu, '').toLowerCase();
        cache.set(str, normalized);
        return normalized;
      };
    })();

    // Pre-process data once
    const data = mappings.map(m => ({
      ...m,
      _old: normalize(m.old),
      _newStation: normalize(m.newStation),
      _newPoint: normalize(m.newPoint),
      _newAddr: normalize(m.newAddr)
    }));

    // DOM elements
    const els = {
      oldList: document.getElementById('oldList'),
      result: document.getElementById('result'),
      oldInput: document.getElementById('oldInput'),
      btnLookup: document.getElementById('btnLookup'),
      btnClear: document.getElementById('btnClear'),
      btnExport: document.getElementById('btnExport'),
      tbody: document.querySelector('#mapTable tbody'),
      filterInput: document.getElementById('filterInput')
    };

    // Populate datalist (use fragment for better performance)
    const fragment = document.createDocumentFragment();
    data.forEach(m => {
      const opt = document.createElement('option');
      opt.value = m.old;
      fragment.appendChild(opt);
    });
    els.oldList.appendChild(fragment);

    // Utility: Copy to clipboard
    const copyToClipboard = async (text, btn) => {
      try {
        await navigator.clipboard.writeText(text);
        const original = btn.textContent;
        btn.textContent = '‚úì ƒê√£ copy';
        btn.classList.add('btn-success');
        setTimeout(() => {
          btn.textContent = original;
          btn.classList.remove('btn-success');
        }, 1500);
      } catch {
        alert('Kh√¥ng th·ªÉ sao ch√©p');
      }
    };

    // Render search result
    const renderResult = (match) => {
      if (!match) {
        els.result.innerHTML = `
          <div class="alert alert-warning" role="alert">
            ‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y tr·∫°m ph√π h·ª£p. Vui l√≤ng ki·ªÉm tra l·∫°i ho·∫∑c ch·ªçn t·ª´ g·ª£i √Ω.
          </div>`;
        return;
      }

      const copyText = match.newPoint ? `${match.newStation} - ${match.newPoint}` : match.newStation;
      const badge = match.newPoint ? `<span class="badge bg-info">${match.newPoint}</span>` : '';

      els.result.innerHTML = `
        <div class="card result-card mb-3">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="text-muted small mb-1">üè• Tr·∫°m c≈©</div>
                <div class="fw-semibold fs-6">${match.old}</div>
                ${match.oldAddr ? `<div class="text-muted small mt-1">üìç ${match.oldAddr}</div>` : ''}
              </div>
              <div class="col-md-6">
                <div class="text-muted small mb-1">‚ú® Sau t·ªï ch·ª©c l·∫°i</div>
                <div class="fs-5 fw-bold text-primary mb-1">${match.newStation} ${badge}</div>
                <div class="text-muted small">üìç ${match.newAddr}</div>
              </div>
              <div class="col-12">
                <button class="btn btn-sm btn-outline-primary copy-btn" data-copy="${copyText}">
                  üìã Copy t√™n ƒë∆°n v·ªã
                </button>
                <button class="btn btn-sm btn-outline-success copy-addr-btn ms-2" data-copy="${match.newAddr}">
                  üìç Copy ƒë·ªãa ch·ªâ
                </button>
              </div>
            </div>
          </div>
        </div>`;

      els.result.querySelector('.copy-btn').addEventListener('click', (e) => {
        copyToClipboard(e.target.dataset.copy, e.target);
      });
      els.result.querySelector('.copy-addr-btn').addEventListener('click', (e) => {
        copyToClipboard(e.target.dataset.copy, e.target);
      });
    };

    // Lookup function
    const lookup = () => {
      const q = normalize(els.oldInput.value.trim());
      if (!q) {
        els.result.innerHTML = '';
        return;
      }

      // Exact match first, then partial
      const match = data.find(m => m._old === q) || data.find(m => m._old.includes(q));
      renderResult(match);
    };

    // Render table (optimized with DocumentFragment)
    const renderTable = (rows) => {
      const frag = document.createDocumentFragment();
      
      rows.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="fw-medium">${m.old}</div>
            ${m.oldAddr ? `<div class="text-muted small">üìç ${m.oldAddr}</div>` : ''}
          </td>
          <td>
            <div class="text-primary fw-semibold">${m.newStation}</div>
            <div class="text-muted small">üìç ${m.newAddr}</div>
          </td>
          <td>${m.newPoint || '<span class="text-muted">‚Äî</span>'}</td>
          <td>
            <button class="btn btn-sm btn-outline-primary copy-btn" data-copy="${m.newStation}${m.newPoint ? ' - ' + m.newPoint : ''}">
              Copy
            </button>
          </td>`;
        frag.appendChild(tr);
      });

      els.tbody.innerHTML = '';
      els.tbody.appendChild(frag);

      // Bind copy buttons (event delegation would be better for large datasets)
      els.tbody.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          copyToClipboard(e.target.dataset.copy, e.target);
        });
      });
    };

    // Initial render
    renderTable(data);

    // Filter with debounce for better performance
    let filterTimeout;
    els.filterInput.addEventListener('input', () => {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(() => {
        const q = normalize(els.filterInput.value.trim());
        if (!q) return renderTable(data);
        const filtered = data.filter(m => 
          m._old.includes(q) || m._newStation.includes(q) || m._newPoint.includes(q) || m._newAddr.includes(q)
        );
        renderTable(filtered);
      }, 300);
    });

    // Sort functionality
    let sortState = { key: 'old', asc: true };
    document.querySelectorAll('#mapTable thead th[data-key]').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        sortState.asc = sortState.key === key ? !sortState.asc : true;
        sortState.key = key;
        
        const sorted = [...data].sort((a, b) => {
          const aa = normalize(a[key] || '');
          const bb = normalize(b[key] || '');
          return sortState.asc ? aa.localeCompare(bb) : bb.localeCompare(aa);
        });
        renderTable(sorted);
      });
    });

    // Event listeners
    els.btnLookup.addEventListener('click', lookup);
    els.oldInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') lookup();
    });
    els.btnClear.addEventListener('click', () => {
      els.oldInput.value = '';
      els.result.innerHTML = '';
      els.oldInput.focus();
    });

    // Export CSV
    els.btnExport.addEventListener('click', () => {
      const csv = [
        ['Tr·∫°m c≈©', 'ƒê·ªãa ch·ªâ c≈©', 'Tr·∫°m m·ªõi', 'ƒêi·ªÉm y t·∫ø', 'ƒê·ªãa ch·ªâ m·ªõi'],
        ...data.map(m => [m.old, m.oldAddr, m.newStation, m.newPoint, m.newAddr])
      ].map(r => r.map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(',')).join('\n');
      
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `doi-chieu-tram-yte-cuchi-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Auto-focus search input
    els.oldInput.focus();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
