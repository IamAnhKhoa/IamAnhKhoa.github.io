<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Phân Tích Xuất Toán BHYT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 95%;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        h1, h4 {
            background: linear-gradient(45deg, #dc3545, #c82333);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
        }
        h1 {
            border-bottom: 3px solid #dc3545;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .api-config {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 5px solid #ffc107;
            box-shadow: 0 4px 15px rgba(255,193,7,0.2);
        }
        .table thead th, .table tbody td { text-align: center; vertical-align: middle; }
        .summary-row {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .summary-row:hover {
            background: linear-gradient(135deg, #ffe6e6 0%, #ffcccb 100%);
            transform: scale(1.01);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .summary-row td:first-child, .table .text-start { text-align: left !important; }
        .detail-container-row td {
            padding: 25px !important;
            background: linear-gradient(135deg, #fff5f5 0%, #ffebee 100%);
            border-radius: 10px;
        }
        .detail-table-wrapper {
            max-height: 60vh;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .detail-table thead {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #ffebee 0%, #f8d7da 100%);
            z-index: 10;
        }
        .reason-cell {
            min-width: 400px;
            text-align: left !important;
            font-weight: 500;
            font-size: 0.95em;
            padding: 15px !important;
            border-radius: 8px;
        }
        .reason-cell.rejected {
            color: #721c24;
            background: linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%);
            border-left: 4px solid #dc3545;
            box-shadow: 0 2px 8px rgba(220,53,69,0.2);
        }
        .reason-cell.analyzing {
            color: #495057;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-left: 4px solid #6c757d;
        }
        .reason-cell.not-analyzed {
            color: #6c757d;
            background: #f8f9fa;
            border-left: 4px solid #dee2e6;
            font-style: italic;
        }
        .loader {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #dc3545;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
            display: none;
        }
        .stats-card, .dashboard-section {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(220,53,69,0.3);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }
        .stat-item { text-align: center; }
        .stat-number { font-size: 2.2em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .stat-label { font-size: 1em; opacity: 0.9; }
        .stat-sublabel { font-size: 0.8em; opacity: 0.8; }
        .icd-tag {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            color: #c62828;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            margin: 2px;
            display: inline-block;
            border: 1px solid #ef5350;
            font-weight: 500;
        }
        .medicine-tag {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            color: #ef6c00;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85em;
            margin: 2px;
            display: inline-block;
            border: 1px solid #ff9800;
            font-weight: 500;
        }
        .btn-modern {
            border-radius: 8px;
            font-weight: 500;
            padding: 8px 16px;
            transition: all 0.3s ease;
        }
        .btn-modern:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .detail-header {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .reason-header {
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .reason-content {
            background: #fff;
            padding: 12px;
            border-radius: 0 0 6px 6px;
            border: 2px solid #dc3545;
            line-height: 1.6;
        }
        .analysis-summary {
            font-size: 0.95em;
            color: #495057;
            margin-top: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-left: 3px solid #6c757d;
            border-radius: 4px;
        }
        .summary-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard Phân Tích Xuất Toán BHYT</h1>
        
        <div class="api-config">
            <h5>Cấu hình Gemini API</h5>
            <div class="row">
                <div class="col-md-8">
                    <input type="password" id="api-key" class="form-control" placeholder="Nhập API Key của Gemini (Google AI Studio)">
                </div>
                <div class="col-md-4">
                    <button type="button" id="test-api" class="btn btn-outline-warning w-100 btn-modern">Kiểm tra API</button>
                </div>
            </div>
            <div id="api-status" class="mt-2"></div>
        </div>

        <div class="mb-3">
            <input type="file" id="excel-file" class="form-control" accept=".xlsx, .xls">
        </div>
        
        <div id="dashboard-container" style="display: none;">
            <div class="stats-card">
                <h4 class="mb-3 text-white">Tổng Quan</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="total-amount">0 đ</div>
                        <div class="stat-label">Tổng Tiền Xuất Toán</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="top-facility-name">N/A</div>
                        <div class="stat-label">CSKCB Xuất Toán Nhiều Nhất</div>
                        <div class="stat-sublabel" id="top-facility-amount">0 đ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-records">0</div>
                        <div class="stat-label">Tổng Số Ca</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-facilities">0</div>
                        <div class="stat-label">Tổng Số CSKCB</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="analyzed-records">0</div>
                        <div class="stat-label">Số Ca Đã Phân Tích</div>
                    </div>
                </div>
            </div>
            <div id="medicine-stats-container" class="mt-4"></div>
        </div>

        <div id="loader" class="loader"></div>
        <div id="results-container" class="mt-4"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let rawDataByCSKCB = {};
        let analysisResults = {};
        let allMedicinesData = [];
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const apiStatus = document.getElementById('api-status');
        let geminiApiKey = '';

        const facilityNameMap = {
            '79764': 'Phòng khám đa khoa thuộc TTYT huyện Củ Chi',
            '79331': 'Trạm y tế thị trấn Củ Chi',
            '79334': 'Trạm y tế Trung Lập Thượng',
            '79339': 'Trạm y tế Trung Lập Hạ',
            '79340': 'Trạm y tế Trung An',
            '79341': 'Trạm y tế Phước Thạnh',
            '79342': 'Trạm y tế Phước Hiệp',
            '79343': 'Trạm y tế Tân An Hội',
            '79344': 'Trạm y tế Phước Vĩnh An',
            '79345': 'Trạm y tế Thái Mỹ',
            '79346': 'Trạm y tế Tân Thạnh Tây',
            '79347': 'Trạm y tế Hòa Phú',
            '79348': 'Trạm y tế Tân Thạnh Đông',
            '79349': 'Trạm y tế Bình Mỹ',
            '79350': 'Trạm y tế Tân Phú Trung',
            '79351': 'Trạm y tế Tân Thông Hội',
            '79332': 'Trạm y tế Phú Mỹ Hưng',
            '79333': 'Trạm y tế An Phú',
            '79335': 'Trạm y tế An Nhơn Tây',
            '79338': 'Trạm y tế Phú Hòa Đông',
            '79337': 'Trạm y tế Phạm Văn Cội',
            '79336': 'Trạm y tế Nhuận Đức'
        };

        function getFacilityDisplayName(cskcb) {
            const name = facilityNameMap[cskcb];
            return name ? `${name} (${cskcb})` : cskcb;
        }

        document.getElementById('api-key').addEventListener('input', function() {
            geminiApiKey = this.value;
        });

        document.getElementById('test-api').addEventListener('click', async function() {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                showApiStatus('Vui lòng nhập API key.', 'error');
                return;
            }
            this.disabled = true;
            this.textContent = 'Đang kiểm tra...';
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Test" }] }] })
                });
                if (response.ok) {
                    showApiStatus('✓ API key hợp lệ!', 'success');
                    geminiApiKey = apiKey;
                } else {
                    const error = await response.json();
                    showApiStatus(`✗ API key không hợp lệ: ${error.error?.message || 'Lỗi không xác định'}`, 'error');
                }
            } catch (error) {
                showApiStatus(`✗ Lỗi kết nối: ${error.message}`, 'error');
            }
            this.disabled = false;
            this.textContent = 'Kiểm tra API';
        });

        function showApiStatus(message, type) {
            apiStatus.innerHTML = `<div class="alert alert-${type === 'error' ? 'danger' : 'success'}">${message}</div>`;
        }

        document.getElementById('excel-file').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            resultsContainer.innerHTML = '';
            document.getElementById('dashboard-container').style.display = 'none';
            document.getElementById('medicine-stats-container').innerHTML = '';
            loader.style.display = 'block';
            rawDataByCSKCB = {};
            analysisResults = {};
            allMedicinesData = [];
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    const specialSheetName = "Ngày y lệnh sau ngày ra viện";
                    if (workbook.SheetNames.includes(specialSheetName)) {
                        handleSpecialSheet(workbook, specialSheetName);
                    } else {
                        let allJsonData = [];
                        workbook.SheetNames.forEach(sheetName => {
                            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            allJsonData.push(...jsonData);
                        });
                        processData(allJsonData);
                        updateDashboard();
                        renderSummaryTable();
                    }
                } catch (error) {
                    alert("Đã xảy ra lỗi khi đọc file. Vui lòng kiểm tra lại định dạng và các cột dữ liệu.\nLỗi: " + error.message);
                } finally {
                    loader.style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function handleSpecialSheet(workbook, sheetName) {
            resultsContainer.innerHTML = '';
            document.getElementById('dashboard-container').style.display = 'none';
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
            
            const validSheetData = sheetData.filter(row => row['MA_CSKCB']);

            if (validSheetData.length === 0) {
                resultsContainer.innerHTML = `<p class="text-info">Sheet "${sheetName}" được tìm thấy nhưng không có dữ liệu hợp lệ.</p>`;
                return;
            }
            
            let overallTotal = 0;
            const facilityErrorTotals = {};
            validSheetData.forEach(row => {
                const amount = parseFloat(row['TONG_XUATTOAN']) || 0;
                overallTotal += amount;
                const cskcb = row['MA_CSKCB'];
                if(cskcb) facilityErrorTotals[cskcb] = (facilityErrorTotals[cskcb] || 0) + amount;
            });
            
            const sortedFacilities = Object.entries(facilityErrorTotals).sort(([,a],[,b]) => b-a);
            let dashboardHTML = `<div class="dashboard-section bg-light text-dark p-3 mb-4">
                                        <h4 class="text-danger">Thống Kê Lỗi Theo Cơ Sở KCB</h4>
                                        <div class="table-responsive" style="max-height: 300px;">
                                            <table class="table table-striped table-hover table-sm">
                                                <thead class="table-dark"><tr><th>#</th><th>Cơ Sở KCB</th><th>Tổng Tiền Lỗi</th></tr></thead>
                                                <tbody>`;
            sortedFacilities.forEach(([cskcb, amount], index) => {
                dashboardHTML += `<tr><td>${index + 1}</td><td class="text-start">${getFacilityDisplayName(cskcb)}</td><td>${amount.toLocaleString('vi-VN')} đ</td></tr>`;
            });
            dashboardHTML += `</tbody></table></div></div>`;
            
            let tableHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; margin-bottom: 15px;">
                                <div>
                                    <h4 class="text-danger mb-2">Lỗi Logic: Ngày Y Lệnh Sau Ngày Ra Viện (Tổng tiền XT: ${overallTotal.toLocaleString('vi-VN')} đ)</h4>
                                    <p class="mb-0">Hiển thị <b>tất cả</b> các trường hợp có lỗi. Lưu ý: Tổng tiền và thống kê được tính trên tất cả các dòng lỗi, bao gồm cả các ca trùng lặp.</p>
                                </div>
                                <button class="btn btn-success btn-modern" id="export-date-error-btn">
                                    <i class="bi bi-file-earmark-excel"></i> Xuất Excel
                                </button>
                            </div>
                                 <div class="table-responsive">
                                     <table class="table table-bordered table-hover">
                                         <thead class="table-dark">
                                             <tr>
                                                 <th>STT</th>
                                                 <th>Cơ Sở KCB</th>
                                                 <th>Họ Tên</th>
                                                 <th>Ngày Vào</th>
                                                 <th>Ngày Ra</th>
                                                 <th>Ngày Y Lệnh</th>
                                                 <th>Tiền Xuất Toán</th>
                                                 <th>Lý Do Xuất Toán (Mặc định)</th>
                                             </tr>
                                         </thead>
                                         <tbody>`;
            validSheetData.forEach((row, index) => {
                const ngayVao = row['NGAY_VAO'] instanceof Date ? row['NGAY_VAO'].toLocaleDateString('vi-VN') : (row['NGAY_VAO'] || '');
                const ngayRa = row['NGAY_RA'] instanceof Date ? row['NGAY_RA'].toLocaleDateString('vi-VN') : (row['NGAY_RA'] || '');
                const ngayYl = row['NGAY_YL'] instanceof Date ? row['NGAY_YL'].toLocaleDateString('vi-VN') : (row['NGAY_YL'] || '');
                const tongXuatToan = (parseFloat(row['TONG_XUATTOAN']) || 0).toLocaleString('vi-VN') + ' đ';

                tableHTML += `<tr>
                                  <td>${index + 1}</td>
                                  <td class="text-start">${getFacilityDisplayName(row['MA_CSKCB'])}</td>
                                  <td>${row['HO_TEN']}</td>
                                  <td>${ngayVao}</td>
                                  <td>${ngayRa}</td>
                                  <td><strong class="text-danger">${ngayYl}</strong></td>
                                  <td>${tongXuatToan}</td>
                                  <td class="text-danger fw-bold">Ngày y lệnh không được sau ngày ra viện</td>
                                </tr>`;
            });

            tableHTML += `</tbody></table></div>`;
            resultsContainer.innerHTML = dashboardHTML + tableHTML;
            
            // Thêm sự kiện cho nút xuất Excel
            document.getElementById('export-date-error-btn').addEventListener('click', () => {
                exportDateErrorToExcel(validSheetData, sortedFacilities, overallTotal);
            });
        }

        function processData(allData) {
            allData.forEach(row => {
                const cskcb = row['MA_CSKCB'];
                if (cskcb) {
                    if (!rawDataByCSKCB[cskcb]) rawDataByCSKCB[cskcb] = [];
                    rawDataByCSKCB[cskcb].push(row);
                    allMedicinesData.push(row);
                }
            });
        }

        function updateDashboard() {
            const allRecords = Object.values(rawDataByCSKCB).flat();
            let totalAmountAll = 0;
            const facilityTotals = {};
            const medicineTotals = {};

            allRecords.forEach(row => {
                const amount = parseFloat(row['THANH_TIEN']) || 0;
                const cskcb = row['MA_CSKCB'];
                const medicine = row['TEN_CP'] || 'Không xác định';
                totalAmountAll += amount;
                facilityTotals[cskcb] = (facilityTotals[cskcb] || 0) + amount;
                medicineTotals[medicine] = (medicineTotals[medicine] || 0) + amount;
            });

            let topFacility = { name: 'N/A', amount: 0 };
            for (const [name, amount] of Object.entries(facilityTotals)) {
                if (amount > topFacility.amount) topFacility = { name, amount };
            }

            document.getElementById('total-amount').textContent = totalAmountAll.toLocaleString('vi-VN') + ' đ';
            document.getElementById('top-facility-name').textContent = getFacilityDisplayName(topFacility.name);
            document.getElementById('top-facility-amount').textContent = topFacility.amount.toLocaleString('vi-VN') + ' đ';
            document.getElementById('total-records').textContent = allRecords.length;
            document.getElementById('total-facilities').textContent = Object.keys(rawDataByCSKCB).length;
            document.getElementById('analyzed-records').textContent = '0';

            renderMedicineStats(medicineTotals);
            document.getElementById('dashboard-container').style.display = 'block';
        }

        function renderMedicineStats(medicineTotals) {
            const sortedMedicine = Object.entries(medicineTotals).sort(([, a], [, b]) => b - a);
            let html = `<div class="dashboard-section bg-light text-dark p-3">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 class="text-danger mb-0">Thống Kê Xuất Toán Theo Chế Phẩm</h4>
                                <button class="btn btn-success btn-sm btn-modern" id="export-medicines-btn">Xuất Tất Cả Thuốc</button>
                            </div>
                            <div class="table-responsive" style="max-height: 300px;">
                                <table class="table table-striped table-hover table-sm">
                                    <thead class="table-dark"><tr><th>#</th><th>Tên Chế Phẩm</th><th>Tổng Tiền</th></tr></thead>
                                    <tbody>`;
            sortedMedicine.forEach(([name, amount], index) => {
                html += `<tr><td>${index + 1}</td><td class="text-start">${name}</td><td>${amount.toLocaleString('vi-VN')} đ</td></tr>`;
            });
            html += `</tbody></table></div></div>`;
            const container = document.getElementById('medicine-stats-container');
            container.innerHTML = html;
            
            document.getElementById('export-medicines-btn').addEventListener('click', () => exportAllMedicines(medicineTotals));
        }

        function exportAllMedicines(medicineTotals) {
            const dataToExport = allMedicinesData.map((row, index) => {
                const ngayVao = row['NGAY_VAO'] instanceof Date ? row['NGAY_VAO'].toLocaleDateString('vi-VN') : row['NGAY_VAO'];
                return {
                    'STT': index + 1,
                    'MA_CSKCB': row['MA_CSKCB'] || '',
                    'TEN_CSKCB': facilityNameMap[row['MA_CSKCB']] || row['MA_CSKCB'] || '',
                    'HO_TEN': row['HO_TEN'] || '',
                    'NGAY_VAO': ngayVao,
                    'TEN_CHE_PHAM': row['TEN_CP'] || '',
                    'THANH_TIEN': parseFloat(row['THANH_TIEN']) || 0,
                    'MA_BENH_CHINH': row['MA_BENH'] || '',
                    'MA_BENH_KEM_THEO': row['MA_BENHKHAC'] || ''
                };
            });

            const summaryData = Object.entries(medicineTotals).map(([name, amount]) => ({
                'TEN_CHE_PHAM': name,
                'TONG_TIEN': amount,
                'SO_LAN_SU_DUNG': allMedicinesData.filter(r => r['TEN_CP'] === name).length
            })).sort((a, b) => b.TONG_TIEN - a.TONG_TIEN);

            const filename = `DuLieuThuoc_${new Date().toISOString().slice(0, 10)}`;
            downloadAsMultiSheetExcel(dataToExport, summaryData, filename);
        }

        function downloadAsMultiSheetExcel(detailData, summaryData, filename) {
            const worksheet1 = XLSX.utils.json_to_sheet(detailData);
            const worksheet2 = XLSX.utils.json_to_sheet(summaryData);
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet2, 'Thong Ke');
            XLSX.utils.book_append_sheet(workbook, worksheet1, 'Chi Tiet');
            
            const colsDetail = Object.keys(detailData[0]);
            worksheet1['!cols'] = colsDetail.map(col => ({ 
                wch: Math.max(...detailData.map(row => row[col] ? row[col].toString().length : 10), col.length) + 2 
            }));
            
            const colsSummary = Object.keys(summaryData[0]);
            worksheet2['!cols'] = colsSummary.map(col => ({ 
                wch: Math.max(...summaryData.map(row => row[col] ? row[col].toString().length : 10), col.length) + 2 
            }));
            
            XLSX.writeFile(workbook, filename + '.xlsx');
        }

        function exportDateErrorToExcel(validSheetData, sortedFacilities, overallTotal) {
            // Dữ liệu chi tiết
            const detailData = validSheetData.map((row, index) => {
                const ngayVao = row['NGAY_VAO'] instanceof Date ? row['NGAY_VAO'].toLocaleDateString('vi-VN') : (row['NGAY_VAO'] || '');
                const ngayRa = row['NGAY_RA'] instanceof Date ? row['NGAY_RA'].toLocaleDateString('vi-VN') : (row['NGAY_RA'] || '');
                const ngayYl = row['NGAY_YL'] instanceof Date ? row['NGAY_YL'].toLocaleDateString('vi-VN') : (row['NGAY_YL'] || '');
                
                return {
                    'STT': index + 1,
                    'MA_CSKCB': row['MA_CSKCB'] || '',
                    'TEN_CSKCB': facilityNameMap[row['MA_CSKCB']] || row['MA_CSKCB'] || '',
                    'HO_TEN': row['HO_TEN'] || '',
                    'NGAY_VAO': ngayVao,
                    'NGAY_RA': ngayRa,
                    'NGAY_Y_LENH': ngayYl,
                    'TIEN_XUAT_TOAN': parseFloat(row['TONG_XUATTOAN']) || 0,
                    'LY_DO_LOI': 'Ngày y lệnh không được sau ngày ra viện'
                };
            });

            // Dữ liệu thống kê theo cơ sở
            const summaryData = sortedFacilities.map(([cskcb, amount], index) => ({
                'STT': index + 1,
                'MA_CSKCB': cskcb,
                'TEN_CSKCB': facilityNameMap[cskcb] || cskcb,
                'SO_TRUONG_HOP_LOI': validSheetData.filter(r => r['MA_CSKCB'] === cskcb).length,
                'TONG_TIEN_LOI': amount
            }));

            // Thêm dòng tổng cộng
            summaryData.push({
                'STT': '',
                'MA_CSKCB': '',
                'TEN_CSKCB': 'TỔNG CỘNG',
                'SO_TRUONG_HOP_LOI': validSheetData.length,
                'TONG_TIEN_LOI': overallTotal
            });

            const filename = `LoiNgayYLenh_${new Date().toISOString().slice(0, 10)}`;
            
            // Tạo workbook với 2 sheet
            const worksheet1 = XLSX.utils.json_to_sheet(detailData);
            const worksheet2 = XLSX.utils.json_to_sheet(summaryData);
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet2, 'Thong Ke Theo CSKCB');
            XLSX.utils.book_append_sheet(workbook, worksheet1, 'Chi Tiet Loi');
            
            // Auto-size columns
            const colsDetail = Object.keys(detailData[0]);
            worksheet1['!cols'] = colsDetail.map(col => ({ 
                wch: Math.max(...detailData.map(row => row[col] ? row[col].toString().length : 10), col.length) + 2 
            }));
            
            const colsSummary = Object.keys(summaryData[0]);
            worksheet2['!cols'] = colsSummary.map(col => ({ 
                wch: Math.max(...summaryData.map(row => row[col] ? row[col].toString().length : 10), col.length) + 2 
            }));
            
            XLSX.writeFile(workbook, filename + '.xlsx');
        }
        
        function updateAnalysisStats() {
            let analyzed = Object.values(analysisResults).reduce((sum, facility) => sum + Object.keys(facility).length, 0);
            document.getElementById('analyzed-records').textContent = analyzed;
        }

        function renderSummaryTable() {
            const summaryData = Object.keys(rawDataByCSKCB).map(cskcb => {
                const rows = rawDataByCSKCB[cskcb];
                const totalAmount = rows.reduce((sum, r) => sum + (parseFloat(r['THANH_TIEN']) || 0), 0);
                return { 'MA_CSKCB': cskcb, 'SO_CA': rows.length, 'TONG_TIEN': totalAmount };
            }).sort((a, b) => b.TONG_TIEN - a.TONG_TIEN);

            let tableHTML = `<h4 class="mt-4">Tổng Hợp Theo Cơ Sở KCB</h4>
                                 <table class="table table-bordered table-hover">
                                 <thead class="table-dark"><tr><th>Cơ Sở KCB</th><th>Số Ca Xuất Toán</th><th>Tổng Tiền</th><th>Trạng thái</th></tr></thead>
                                 <tbody>`;
            summaryData.forEach(row => {
                tableHTML += `<tr class="summary-row" data-cskcb="${row['MA_CSKCB']}">
                                  <td class="text-start">${getFacilityDisplayName(row['MA_CSKCB'])}</td>
                                  <td>${row['SO_CA']}</td>
                                  <td>${row['TONG_TIEN'].toLocaleString('vi-VN')} đ</td>
                                  <td id="status-${row['MA_CSKCB']}"><span class="badge bg-secondary">Chưa phân tích</span></td>
                                 </tr>`;
            });
            tableHTML += '</tbody></table>';
            resultsContainer.innerHTML = tableHTML;
            addSummaryClickListeners();
        }

        function addSummaryClickListeners() {
            document.querySelectorAll('.summary-row').forEach(row => {
                row.addEventListener('click', function() {
                    const cskcb = this.dataset.cskcb;
                    const existingDetailRow = document.querySelector('.detail-container-row');
                    if (existingDetailRow) existingDetailRow.remove();
                    document.querySelectorAll('.summary-row.table-active').forEach(r => r.classList.remove('table-active'));
                    this.classList.add('table-active');
                    const detailRow = document.createElement('tr');
                    detailRow.className = 'detail-container-row';
                    const detailCell = document.createElement('td');
                    detailCell.colSpan = 4;
                    detailCell.innerHTML = createDetailView(cskcb);
                    detailRow.appendChild(detailCell);
                    this.after(detailRow);
                    addDetailViewListeners(cskcb);
                });
            });
        }
                
        function createDetailView(cskcb) {
            const rows = rawDataByCSKCB[cskcb];
            const detailColumns = ['HO_TEN', 'NGAY_VAO', 'TEN_CP', 'THANH_TIEN', 'MA_BENH', 'MA_BENHKHAC'];
            let html = `
                <div class="detail-header">
                    <h5 class="mb-3">Chi tiết ca xuất toán - ${getFacilityDisplayName(cskcb)}</h5>
                    <div class="d-flex justify-content-between align-items-center">
                         <input type="text" id="filter-detail-${cskcb}" class="form-control w-50" placeholder="Lọc theo tên thuốc, họ tên, mã bệnh...">
                         <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm btn-modern" id="export-facility-medicines-${cskcb}">Xuất Thuốc</button>
                            <button class="btn btn-primary btn-sm btn-modern" id="export-excel-${cskcb}">Xuất Excel</button>
                            <button class="btn btn-danger btn-sm btn-modern" id="analyze-all-${cskcb}">Phân tích tất cả</button>
                         </div>
                    </div>
                </div>
                <div class="detail-table-wrapper">
                    <table class="table table-sm table-bordered table-striped detail-table">
                        <thead><tr>
                            ${detailColumns.map(c => `<th>${c}</th>`).join('')}
                            <th>Thao tác</th>
                            <th style="min-width: 400px;">Lý do xuất toán (AI)</th>
                        </tr></thead><tbody id="tbody-${cskcb}">`;
            rows.forEach((row, index) => {
                html += '<tr>';
                detailColumns.forEach(col => {
                    let cellValue = row[col] || '';
                    let formattedContent = cellValue;
                    if (col === 'NGAY_VAO' && cellValue instanceof Date) {
                        formattedContent = cellValue.toLocaleDateString('vi-VN');
                    } else if (col === 'THANH_TIEN') {
                        formattedContent = (parseFloat(cellValue) || 0).toLocaleString('vi-VN') + ' đ';
                    } else if (col === 'MA_BENH' || col === 'MA_BENHKHAC') {
                        formattedContent = cellValue.toString().split(';').map(c => c.trim()).filter(Boolean).map(code => `<span class="icd-tag">${code}</span>`).join(' ');
                    } else if (col === 'TEN_CP') {
                        formattedContent = `<span class="medicine-tag">${cellValue}</span>`;
                    }
                    html += `<td>${formattedContent}</td>`;
                });
                html += `<td><button class="btn btn-danger btn-sm ai-analyze-btn btn-modern" data-cskcb="${cskcb}" data-row-index="${index}">Phân tích</button></td>
                             <td class="reason-cell not-analyzed" id="reason-${cskcb}-${index}">Chưa phân tích</td></tr>`;
            });
            html += `</tbody></table></div>`;
            return html;
        }

        function addDetailViewListeners(cskcb) {
            document.getElementById(`filter-detail-${cskcb}`).addEventListener('input', function() { 
                filterDetailTable(cskcb, this.value); 
            });
            document.getElementById(`export-facility-medicines-${cskcb}`).addEventListener('click', () => {
                exportFacilityMedicines(cskcb);
            });
            document.getElementById(`export-excel-${cskcb}`).addEventListener('click', () => {
                exportToExcel(cskcb);
            });
            document.getElementById(`analyze-all-${cskcb}`).addEventListener('click', function() {
                if (!geminiApiKey) { alert('Vui lòng cấu hình API key.'); return; }
                const buttons = document.querySelectorAll(`#tbody-${cskcb} .ai-analyze-btn:not(:disabled)`);
                buttons.forEach((btn, index) => { setTimeout(() => btn.click(), index * 1200); });
            });
            document.querySelectorAll(`#tbody-${cskcb} .ai-analyze-btn`).forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (!geminiApiKey) { alert('Vui lòng cấu hình API key.'); return; }
                    const rowIndex = this.dataset.rowIndex, cskcb = this.dataset.cskcb;
                    const rowData = rawDataByCSKCB[cskcb][rowIndex];
                    const reasonCell = document.getElementById(`reason-${cskcb}-${rowIndex}`);
                    this.disabled = true; 
                    this.innerHTML = 'Đang xử lý...';
                    reasonCell.innerHTML = 'Đang phân tích...'; 
                    reasonCell.className = 'reason-cell analyzing';
                    try {
                        const analysis = await analyzeWithGemini(rowData);
                        if (!analysisResults[cskcb]) analysisResults[cskcb] = {};
                        analysisResults[cskcb][rowIndex] = analysis;
                        reasonCell.innerHTML = `<div class="reason-header">LÝ DO XUẤT TOÁN</div>
                                                 <div class="reason-content"><strong>Lý do chính:</strong> ${analysis.summary}
                                                 ${analysis.details && analysis.details.length > 0 ? `<div class="analysis-summary"><strong>Chi tiết:</strong> ${analysis.details.join('; ')}</div>` : ''}
                                                 </div>`;
                        reasonCell.className = 'reason-cell rejected';
                        this.innerHTML = 'Đã xem';
                        updateAnalysisStats(); 
                        updateFacilityStatus(cskcb);
                    } catch (error) {
                        reasonCell.innerHTML = `<div class="reason-header">LỖI</div>
                                                 <div class="reason-content"><strong>Lỗi:</strong> ${error.message}</div>`;
                        reasonCell.className = 'reason-cell rejected';
                        this.disabled = false; 
                        this.innerHTML = 'Thử lại';
                    }
                });
            });
        }

        function filterDetailTable(cskcb, searchTerm) {
            const term = searchTerm.toLowerCase();
            const rows = document.getElementById(`tbody-${cskcb}`).getElementsByTagName('tr');
            for (const row of rows) {
                row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
            }
        }

        function exportFacilityMedicines(cskcb) {
            const facilityRows = rawDataByCSKCB[cskcb];
            if (!facilityRows || facilityRows.length === 0) { 
                alert('Không có dữ liệu để xuất.'); 
                return; 
            }

            const medicineTotals = {};
            facilityRows.forEach(row => {
                const medicine = row['TEN_CP'] || 'Không xác định';
                const amount = parseFloat(row['THANH_TIEN']) || 0;
                medicineTotals[medicine] = (medicineTotals[medicine] || 0) + amount;
            });

            const detailData = facilityRows.map((row, index) => {
                const ngayVao = row['NGAY_VAO'] instanceof Date ? row['NGAY_VAO'].toLocaleDateString('vi-VN') : row['NGAY_VAO'];
                return {
                    'STT': index + 1,
                    'HO_TEN': row['HO_TEN'] || '',
                    'NGAY_VAO': ngayVao,
                    'TEN_CHE_PHAM': row['TEN_CP'] || '',
                    'THANH_TIEN': parseFloat(row['THANH_TIEN']) || 0,
                    'MA_BENH_CHINH': row['MA_BENH'] || '',
                    'MA_BENH_KEM_THEO': row['MA_BENHKHAC'] || ''
                };
            });

            const summaryData = Object.entries(medicineTotals).map(([name, amount]) => ({
                'TEN_CHE_PHAM': name,
                'TONG_TIEN': amount,
                'SO_LAN_SU_DUNG': facilityRows.filter(r => r['TEN_CP'] === name).length
            })).sort((a, b) => b.TONG_TIEN - a.TONG_TIEN);

            const filename = `ThuocCSKCB_${cskcb}_${new Date().toISOString().slice(0, 10)}`;
            downloadAsMultiSheetExcel(detailData, summaryData, filename);
        }

        function exportToExcel(cskcb) {
            const allRows = rawDataByCSKCB[cskcb];
            if (!allRows || allRows.length === 0) { alert('Không có dữ liệu để xuất.'); return; }
            const dataToExport = allRows.map((row, index) => {
                const analysis = analysisResults[cskcb]?.[index];
                const ngayVao = row['NGAY_VAO'] instanceof Date ? row['NGAY_VAO'].toLocaleDateString('vi-VN') : row['NGAY_VAO'];
                return {
                    'STT': index + 1,
                    'MA_CSKCB': cskcb,
                    'TEN_CSKCB': facilityNameMap[cskcb] || cskcb,
                    'HO_TEN': row['HO_TEN'] || '',
                    'NGAY_VAO': ngayVao,
                    'TEN_CHE_PHAM': row['TEN_CP'] || '',
                    'THANH_TIEN': parseFloat(row['THANH_TIEN']) || 0,
                    'MA_BENH_CHINH': row['MA_BENH'] || '',
                    'MA_BENH_KEM_THEO': row['MA_BENHKHAC'] || '',
                    'TRANG_THAI_PHAN_TICH': analysis ? 'Đã phân tích' : 'Chưa phân tích',
                    'LY_DO_XUAT_TOAN': analysis ? analysis.summary : '',
                    'CHI_TIET_AI': analysis && analysis.details ? analysis.details.join('; ') : ''
                };
            });
            const filename = `KetQuaXuatToan_${cskcb}_${new Date().toISOString().slice(0, 10)}`;
            downloadAsExcel(dataToExport, filename);
        }

        function downloadAsExcel(data, filename) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'KetQua');
            const cols = Object.keys(data[0]);
            worksheet['!cols'] = cols.map(col => ({ 
                wch: Math.max(...data.map(row => row[col] ? row[col].toString().length : 10), col.length) + 2 
            }));
            XLSX.writeFile(workbook, filename + '.xlsx');
        }

        async function analyzeWithGemini(rowData) {
            if (!geminiApiKey) throw new Error('API key chưa được cấu hình');
            const prompt = `Bạn là chuyên gia giám định BHYT Việt Nam. Giả định việc BHYT từối thanh toán là ĐÚNG. LƯU Ý: Chế phẩm này LUÔN THUỘC DANH MỤC BHYT.
                                THÔNG TIN: Chế phẩm: ${rowData['TEN_CP'] || 'Không có'}, Mã bệnh chính (ICD-10): ${rowData['MA_BENH'] || 'Không có'}, Mã bệnh kèm theo (ICD-10): ${rowData['MA_BENHKHAC'] || 'Không có'}.
                                YÊU CẦU: 1. summary: Tóm tắt lý do chính từối. 2. details: Giải thích tại sao chẩn đoán không phù hợp và liệt kê các bệnh lý khác (kèm mã ICD-10) có thể chống chỉ định hoặc tương tác với chế phẩm này.
                                TRẢ LỜI JSON: { "summary": "Lý do tóm tắt...", "details": ["Chi tiết 1...", "Chi tiết 2..."] }`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }], 
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                if (!response.ok) {
                    const error = await response.json(); 
                    throw new Error(error.error?.message || `Lỗi API: ${response.status}`);
                }
                const data = await response.json();
                const parsedResult = JSON.parse(data.candidates[0].content.parts[0].text);
                return { summary: parsedResult.summary || "Không có tóm tắt.", details: parsedResult.details || [] };
            } catch (error) {
                console.error("Lỗi Gemini API:", error); 
                throw new Error('Lỗi phân tích từ Gemini. ' + error.message);
            }
        }

        function updateFacilityStatus(cskcb) {
            const statusCell = document.getElementById(`status-${cskcb}`);
            if (!statusCell) return;
            const totalRows = rawDataByCSKCB[cskcb]?.length || 0;
            const analyzedCount = Object.keys(analysisResults[cskcb] || {}).length;
            if (analyzedCount === 0) {
                statusCell.innerHTML = `<span class="badge bg-secondary">Chưa phân tích</span>`;
            } else if (analyzedCount < totalRows) {
                statusCell.innerHTML = `<div class="progress" role="progressbar" style="height: 20px;">
                                           <div class="progress-bar progress-bar-striped bg-warning text-dark" style="width: ${analyzedCount/totalRows*100}%"><b>${analyzedCount}/${totalRows}</b></div>
                                           </div>`;
            } else {
                statusCell.innerHTML = `<span class="badge bg-success">✓ Đã xong</span>`;
            }
        }
    </script>
</body>
</html>
