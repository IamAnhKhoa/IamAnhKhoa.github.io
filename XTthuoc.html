<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ph√¢n T√≠ch T√≠nh H·ª£p L·ªá Ch·∫ø Ph·∫©m Y T·∫ø</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 30px; background-color: #f8f9fa; font-family: sans-serif; }
        .container { max-width: 95%; background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #343a40; border-bottom: 2px solid #198754; padding-bottom: 10px; margin-bottom: 20px; }
        .api-config { background-color: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff; }
        .table thead th, .table tbody td { text-align: center; vertical-align: middle; }
        .summary-row { cursor: pointer; }
        .summary-row:hover { background-color: #e9ecef; }
        .summary-row td:first-child { text-align: left; font-weight: bold; }
        .detail-container-row td { padding: 20px !important; background-color: #f0f2f5; }
        .detail-table-wrapper { max-height: 55vh; overflow-y: auto; }
        .detail-table thead { position: sticky; top: 0; background-color: #e0e5ec; }
        .reason-cell { min-width: 300px; text-align: left !important; font-weight: 500; font-size: 0.9em; }
        .reason-cell.rejected { color: #b92c2c; background-color: #ffeaea; }
        .reason-cell.approved { color: #198754; background-color: #eafaf1; }
        .reason-cell.warning { color: #e67e22; background-color: #fff3e0; }
        .reason-cell.analyzing { color: #f39c12; background-color: #fefbf3; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        .ai-analyze-btn:disabled { opacity: 0.6; }
        .api-status { padding: 10px; border-radius: 5px; margin-bottom: 15px; }
        .api-status.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .api-status.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .stats-card { background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-item { text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        .analysis-summary { background-color: #f8f9fa; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; border-radius: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .icd-tag { background-color: #e3f2fd; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin: 1px; display: inline-block; }
        .medicine-tag { background-color: #f3e5f5; color: #7b1fa2; padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin: 1px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• Ph√¢n T√≠ch T√≠nh H·ª£p L·ªá Ch·∫ø Ph·∫©m Y T·∫ø</h1>
        <p>Ph√¢n t√≠ch m·ªëi quan h·ªá gi·ªØa m√£ b·ªánh (MA_BENH, MA_BENHKHAC) v√† ch·∫ø ph·∫©m ƒë∆∞·ª£c k√™ (TEN_CP) ƒë·ªÉ ƒë√°nh gi√° t√≠nh h·ª£p l·ªá c·ªßa ƒë∆°n thu·ªëc.</p>
        
        <!-- C·∫•u h√¨nh API -->
        <div class="api-config">
            <h5>üîë C·∫•u h√¨nh Gemini API</h5>
            <div class="row">
                <div class="col-md-8">
                    <input type="password" id="api-key" class="form-control" placeholder="Nh·∫≠p API Key c·ªßa Gemini (Google AI Studio)">
                </div>
                <div class="col-md-4">
                    <button type="button" id="test-api" class="btn btn-outline-primary w-100">Ki·ªÉm tra API</button>
                </div>
            </div>
            <small class="text-muted">
                <strong>H∆∞·ªõng d·∫´n:</strong> V√†o <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> 
                ƒë·ªÉ t·∫°o API key mi·ªÖn ph√≠. API key ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô v√† kh√¥ng chia s·∫ª.
            </small>
            <div id="api-status"></div>
        </div>

        <div class="mb-3">
            <input type="file" id="excel-file" class="form-control" accept=".xlsx, .xls">
        </div>
        
        <!-- Statistics Dashboard -->
        <div id="stats-dashboard" style="display: none;">
            <div class="stats-card">
                <h5 class="mb-3">üìä T·ªïng quan ph√¢n t√≠ch</h5>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="total-records">0</div>
                        <div class="stat-label">T·ªïng b·∫£n ghi</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-facilities">0</div>
                        <div class="stat-label">C∆° s·ªü KCB</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="analyzed-records">0</div>
                        <div class="stat-label">ƒê√£ ph√¢n t√≠ch</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="valid-prescriptions">0</div>
                        <div class="stat-label">ƒê∆°n h·ª£p l·ªá</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="invalid-prescriptions">0</div>
                        <div class="stat-label">ƒê∆°n c√≥ v·∫•n ƒë·ªÅ</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loader" class="loader"></div>
        <div id="results-container"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let rawDataByCSKCB = {};
        let analysisResults = {};
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const apiStatus = document.getElementById('api-status');
        let geminiApiKey = sessionStorage.getItem('gemini-api-key') || '';
        
        // Load saved API key
        if (geminiApiKey) {
            document.getElementById('api-key').value = geminiApiKey;
        }

        // Save API key when changed
        document.getElementById('api-key').addEventListener('input', function() {
            geminiApiKey = this.value;
            sessionStorage.setItem('gemini-api-key', geminiApiKey);
        });

        // Test API connection
        document.getElementById('test-api').addEventListener('click', async function() {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                showApiStatus('Vui l√≤ng nh·∫≠p API key.', 'error');
                return;
            }

            this.disabled = true;
            this.textContent = 'ƒêang ki·ªÉm tra...';

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "Test connection"
                            }]
                        }]
                    })
                });

                if (response.ok) {
                    showApiStatus('‚úÖ API key h·ª£p l·ªá! S·∫µn s√†ng ph√¢n t√≠ch d·ªØ li·ªáu.', 'success');
                    geminiApiKey = apiKey;
                } else {
                    const error = await response.json();
                    showApiStatus(`‚ùå API key kh√¥ng h·ª£p l·ªá: ${error.error?.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showApiStatus(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`, 'error');
            }

            this.disabled = false;
            this.textContent = 'Ki·ªÉm tra API';
        });

        function showApiStatus(message, type) {
            apiStatus.innerHTML = `<div class="api-status ${type}">${message}</div>`;
        }

        document.getElementById('excel-file').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            resultsContainer.innerHTML = '';
            document.getElementById('stats-dashboard').style.display = 'none';
            loader.style.display = 'block';
            rawDataByCSKCB = {};
            analysisResults = {};

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    let allJsonData = [];

                    workbook.SheetNames.forEach(sheetName => {
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                        allJsonData.push(...jsonData);
                    });

                    processData(allJsonData);
                    renderSummaryTable();
                    updateStatsDashboard();
                } catch (error) {
                    alert("ƒê√£ x·∫£y ra l·ªói khi ƒë·ªçc file. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng file Excel c·ªßa b·∫°n.\nL·ªói: " + error.message);
                } finally {
                    loader.style.display = 'none';
                }
            };
            reader.onerror = function() {
                 loader.style.display = 'none';
                 alert("Kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c file ƒë√£ ch·ªçn.");
            };
            reader.readAsArrayBuffer(file);
        });

        function processData(allData) {
            allData.forEach(row => {
                const cskcb = row['MA_CSKCB'];
                if (cskcb) {
                    if (!rawDataByCSKCB[cskcb]) {
                        rawDataByCSKCB[cskcb] = [];
                    }
                    rawDataByCSKCB[cskcb].push(row);
                }
            });
        }

        function updateStatsDashboard() {
            const totalRecords = Object.values(rawDataByCSKCB).reduce((sum, arr) => sum + arr.length, 0);
            const totalFacilities = Object.keys(rawDataByCSKCB).length;
            
            document.getElementById('total-records').textContent = totalRecords;
            document.getElementById('total-facilities').textContent = totalFacilities;
            document.getElementById('analyzed-records').textContent = '0';
            document.getElementById('valid-prescriptions').textContent = '0';
            document.getElementById('invalid-prescriptions').textContent = '0';
            
            document.getElementById('stats-dashboard').style.display = 'block';
        }

        function updateAnalysisStats() {
            let analyzed = 0, valid = 0, invalid = 0;
            
            Object.values(analysisResults).forEach(facilityResults => {
                Object.values(facilityResults).forEach(result => {
                    analyzed++;
                    if (result.isValid) valid++;
                    else invalid++;
                });
            });
            
            document.getElementById('analyzed-records').textContent = analyzed;
            document.getElementById('valid-prescriptions').textContent = valid;
            document.getElementById('invalid-prescriptions').textContent = invalid;
        }

        function renderSummaryTable() {
            const summaryData = Object.keys(rawDataByCSKCB).map(cskcb => {
                const rows = rawDataByCSKCB[cskcb];
                return {
                    'MA_CSKCB': cskcb,
                    'TEN_CP': new Set(rows.map(r => r['TEN_CP']).filter(Boolean)).size,
                    'MA_BENH': new Set(rows.map(r => r['MA_BENH']).filter(Boolean)).size,
                    'MA_BENHKHAC': new Set(rows.flatMap(r => (r['MA_BENHKHAC'] || '').toString().split(';')).map(s => s.trim()).filter(Boolean)).size,
                    'SO_CA': rows.length
                };
            }).sort((a, b) => a['MA_CSKCB'] > b['MA_CSKCB'] ? 1 : -1);

            if (summaryData.length === 0) {
                resultsContainer.innerHTML = '<p class="text-warning">Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong file.</p>';
                return;
            }

            const columns = ['TEN_CP', 'MA_BENH', 'MA_BENHKHAC', 'SO_CA'];
            let tableHTML = '<table class="table table-bordered table-hover">';
            tableHTML += `<thead class="table-light"><tr><th>MA_CSKCB</th>${columns.map(c => `<th>${c}</th>`).join('')}<th>Tr·∫°ng th√°i ph√¢n t√≠ch</th></tr></thead><tbody>`;
            summaryData.forEach(row => {
                tableHTML += `<tr class="summary-row" data-cskcb="${row['MA_CSKCB']}"><td>${row['MA_CSKCB']}</td>${columns.map(c => `<td>${row[c]}</td>`).join('')}<td id="status-${row['MA_CSKCB']}">Ch∆∞a ph√¢n t√≠ch</td></tr>`;
            });
            tableHTML += '</tbody></table>';
            resultsContainer.innerHTML = tableHTML;
            addSummaryClickListeners();
        }

        function addSummaryClickListeners() {
            document.querySelectorAll('.summary-row').forEach(row => {
                row.addEventListener('click', function() {
                    const cskcb = this.dataset.cskcb;
                    const existingDetailRow = document.querySelector('.detail-container-row');
                    const wasActive = this.classList.contains('table-active');

                    if (existingDetailRow) existingDetailRow.remove();
                    document.querySelectorAll('.summary-row.table-active').forEach(r => r.classList.remove('table-active'));

                    if (!wasActive) {
                        this.classList.add('table-active');
                        const detailRow = document.createElement('tr');
                        detailRow.className = 'detail-container-row';
                        const detailCell = document.createElement('td');
                        detailCell.colSpan = this.cells.length;
                        detailCell.innerHTML = createDetailView(cskcb);
                        detailRow.appendChild(detailCell);
                        this.after(detailRow);
                        addDetailViewListeners(cskcb);
                    }
                });
            });
        }
        
        function createDetailView(cskcb) {
            const rows = rawDataByCSKCB[cskcb];
            const detailColumns = ['MA_BN', 'HO_TEN', 'TEN_CP', 'MA_BENH', 'MA_BENHKHAC'];
            let html = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Chi ti·∫øt ph√¢n t√≠ch ch·∫ø ph·∫©m - CSKCB: ${cskcb}</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success btn-sm" id="analyze-all-${cskcb}">Ph√¢n t√≠ch t·∫•t c·∫£</button>
                        <button class="btn btn-info btn-sm" id="export-results-${cskcb}">Xu·∫•t k·∫øt qu·∫£</button>
                        <input type="text" id="search-${cskcb}" class="form-control w-50" placeholder="üîç T√¨m ki·∫øm...">
                    </div>
                </div>`;

            // Analysis summary for this facility
            if (analysisResults[cskcb]) {
                const facilityResults = Object.values(analysisResults[cskcb]);
                const validCount = facilityResults.filter(r => r.isValid).length;
                const totalCount = facilityResults.length;
                html += `
                    <div class="analysis-summary">
                        <strong>K·∫øt qu·∫£ ph√¢n t√≠ch:</strong> ${validCount}/${totalCount} ƒë∆°n h·ª£p l·ªá 
                        (${totalCount > 0 ? Math.round(validCount/totalCount*100) : 0}%)
                    </div>`;
            }

            html += `
                <div class="detail-table-wrapper">
                    <table class="table table-sm table-bordered table-striped detail-table">
                        <thead class="table-info"><tr>
                            ${detailColumns.map(c => `<th>${c}</th>`).join('')}
                            <th>Ph√¢n t√≠ch</th>
                            <th>K·∫øt qu·∫£ ph√¢n t√≠ch chi ti·∫øt</th>
                        </tr></thead><tbody id="tbody-${cskcb}">`;

            rows.forEach((row, index) => {
                html += '<tr>';
                detailColumns.forEach(col => { 
                    let cellContent = row[col] || '';
                    // Format ICD codes and medicines with tags
                    if (col === 'MA_BENH' || col === 'MA_BENHKHAC') {
                        if (cellContent) {
                            const codes = cellContent.toString().split(';').map(c => c.trim()).filter(Boolean);
                            cellContent = codes.map(code => `<span class="icd-tag">${code}</span>`).join(' ');
                        }
                    } else if (col === 'TEN_CP') {
                        if (cellContent) {
                            cellContent = `<span class="medicine-tag">${cellContent}</span>`;
                        }
                    }
                    html += `<td>${cellContent}</td>`;
                });
                html += `
                    <td><button class="btn btn-info btn-sm ai-analyze-btn" data-cskcb="${cskcb}" data-row-index="${index}">Ph√¢n t√≠ch</button></td>
                    <td class="reason-cell" id="reason-${cskcb}-${index}"></td>
                </tr>`;
            });
            
            html += `</tbody></table></div>`;
            return html;
        }

        function addDetailViewListeners(cskcb) {
            document.getElementById(`search-${cskcb}`).addEventListener('input', function() {
                filterDetailTable(cskcb, this.value);
            });

            // Export results
            document.getElementById(`export-results-${cskcb}`).addEventListener('click', function() {
                exportResults(cskcb);
            });

            // Analyze all
            document.getElementById(`analyze-all-${cskcb}`).addEventListener('click', function() {
                if (!geminiApiKey) {
                    alert('Vui l√≤ng c·∫•u h√¨nh API key tr∆∞·ªõc khi s·ª≠ d·ª•ng.');
                    return;
                }

                const buttons = document.querySelectorAll(`#tbody-${cskcb} .ai-analyze-btn:not(:disabled)`);
                buttons.forEach((btn, index) => {
                    setTimeout(() => btn.click(), index * 1500); // Stagger requests
                });
            });

            // Individual analysis
            document.querySelectorAll(`#tbody-${cskcb} .ai-analyze-btn`).forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (!geminiApiKey) {
                        alert('Vui l√≤ng c·∫•u h√¨nh API key tr∆∞·ªõc khi s·ª≠ d·ª•ng.');
                        return;
                    }

                    const rowIndex = this.dataset.rowIndex;
                    const cskcb = this.dataset.cskcb;
                    const rowData = rawDataByCSKCB[cskcb][rowIndex];
                    const reasonCell = document.getElementById(`reason-${cskcb}-${rowIndex}`);
                    
                    // Update UI
                    this.disabled = true;
                    this.textContent = 'ƒêang ph√¢n t√≠ch...';
                    reasonCell.textContent = 'ƒêang ph√¢n t√≠ch t√≠nh h·ª£p l·ªá c·ªßa ch·∫ø ph·∫©m v·ªõi AI...';
                    reasonCell.className = 'reason-cell analyzing';

                    try {
                        const analysis = await analyzeWithGemini(rowData);
                        
                        // Store result
                        if (!analysisResults[cskcb]) analysisResults[cskcb] = {};
                        analysisResults[cskcb][rowIndex] = analysis;
                        
                        reasonCell.innerHTML = formatAnalysisResult(analysis);
                        
                        // Determine color based on analysis result
                        if (analysis.isValid) {
                            reasonCell.className = 'reason-cell approved';
                        } else if (analysis.hasWarning) {
                            reasonCell.className = 'reason-cell warning';
                        } else {
                            reasonCell.className = 'reason-cell rejected';
                        }
                        
                        this.textContent = 'ƒê√£ ph√¢n t√≠ch';
                        updateAnalysisStats();
                    } catch (error) {
                        reasonCell.textContent = `L·ªói ph√¢n t√≠ch: ${error.message}`;
                        reasonCell.className = 'reason-cell rejected';
                        this.disabled = false;
                        this.textContent = 'Ph√¢n t√≠ch l·∫°i';
                    }
                });
            });
        }

        function formatAnalysisResult(analysis) {
            let html = `<strong>${analysis.isValid ? '‚úÖ H·ª¢P L·ªÜ' : analysis.hasWarning ? '‚ö†Ô∏è C·∫¶N KI·ªÇM TRA' : '‚ùå KH√îNG H·ª¢P L·ªÜ'}</strong><br>`;
            html += `${analysis.summary}<br>`;
            if (analysis.details && analysis.details.length > 0) {
                html += `<small><em>Chi ti·∫øt: ${analysis.details.join('; ')}</em></small>`;
            }
            return html;
        }

        function filterDetailTable(cskcb, searchTerm) {
            const term = searchTerm.toLowerCase();
            const rows = document.getElementById(`tbody-${cskcb}`).getElementsByTagName('tr');
            for (const row of rows) {
                if (row.textContent.toLowerCase().includes(term)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        function exportResults(cskcb) {
            if (!analysisResults[cskcb]) {
                alert('Ch∆∞a c√≥ k·∫øt qu·∫£ ph√¢n t√≠ch n√†o ƒë·ªÉ xu·∫•t.');
                return;
            }

            const results = [];
            const rows = rawDataByCSKCB[cskcb];
            
            Object.keys(analysisResults[cskcb]).forEach(rowIndex => {
                const row = rows[rowIndex];
                const analysis = analysisResults[cskcb][rowIndex];
                results.push({
                    'MA_CSKCB': cskcb,
                    'MA_BN': row['MA_BN'],
                    'HO_TEN': row['HO_TEN'],
                    'TEN_CP': row['TEN_CP'],
                    'MA_BENH': row['MA_BENH'],
                    'MA_BENHKHAC': row['MA_BENHKHAC'],
                    'KET_QUA': analysis.isValid ? 'H·ª¢P L·ªÜ' : analysis.hasWarning ? 'C·∫¶N KI·ªÇM TRA' : 'KH√îNG H·ª¢P L·ªÜ',
                    'MO_TA': analysis.summary,
                    'CHI_TIET': analysis.details ? analysis.details.join('; ') : ''
                });
            });

            const csvContent = convertToCSV(results);
            downloadCSV(csvContent, `ket_qua_phan_tich_${cskcb}.csv`);
        }

        function convertToCSV(data) {
            if (!data.length) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Enhanced Gemini API analysis focusing on medicine-disease relationship
        async function analyzeWithGemini(rowData) {
            if (!geminiApiKey) {
                throw new Error('API key ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh');
            }

            const prompt = `
B·∫°n l√† chuy√™n gia ph√¢n t√≠ch ƒë∆°n thu·ªëc y t·∫ø. Ph√¢n t√≠ch t√≠nh h·ª£p l·ªá c·ªßa vi·ªác k√™ ch·∫ø ph·∫©m d·ª±a tr√™n ch·∫©n ƒëo√°n:

TH√îNG TIN B·ªÜNH NH√ÇN:
- M√£ b·ªánh nh√¢n: ${rowData['MA_BN'] || 'Kh√¥ng c√≥'}
- H·ªç t√™n: ${rowData['HO_TEN'] || 'Kh√¥ng c√≥'}
- Ch·∫ø ph·∫©m ƒë∆∞·ª£c k√™: ${rowData['TEN_CP'] || 'Kh√¥ng c√≥'}
- M√£ b·ªánh ch√≠nh: ${rowData['MA_BENH'] || 'Kh√¥ng c√≥'}
- M√£ b·ªánh k√®m theo: ${rowData['MA_BENHKHAC'] || 'Kh√¥ng c√≥'}

Y√äU C·∫¶U PH√ÇN T√çCH:
1. ƒê√°nh gi√° m·ªëi quan h·ªá gi·ªØa ch·∫ø ph·∫©m v√† c√°c m√£ b·ªánh
2. X√°c ƒë·ªãnh t√≠nh h·ª£p l·ªá c·ªßa vi·ªác k√™ ƒë∆°n
3. Ph√°t hi·ªán c√°c v·∫•n ƒë·ªÅ ti·ªÅm ·∫©n (t∆∞∆°ng t√°c thu·ªëc, ch·ªëng ch·ªâ ƒë·ªãnh, li·ªÅu d√πng)

Tr·∫£ l·ªùi theo format JSON:
{
  "isValid": true/false,
  "hasWarning": true/false,
  "summary": "T√≥m t·∫Øt ng·∫Øn g·ªçn k·∫øt qu·∫£ ph√¢n t√≠ch",
  "details": ["Chi ti·∫øt 1", "Chi ti·∫øt 2", ...]
}

Ch·ªâ tr·∫£ l·ªùi JSON h·ª£p l·ªá, kh√¥ng th√™m text kh√°c, ƒë·ª´ng c√≥ hi·ªán ki·ªÉu [```json { "isValid": false, "hasWarning": true, "summary":] n√†y.
`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.2,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 900,
                        }
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    const responseText = data.candidates[0].content.parts[0].text.trim();
                    
                    try {
                        // Try to parse JSON response
                        const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            return JSON.parse(jsonMatch[0]);
                        } else {
                            // Fallback if JSON parsing fails
                            return {
                                isValid: responseText.toLowerCase().includes('h·ª£p l·ªá') && !responseText.toLowerCase().includes('kh√¥ng h·ª£p l·ªá'),
                                hasWarning: responseText.toLowerCase().includes('c·∫ßn ki·ªÉm tra') || responseText.toLowerCase().includes('th·∫≠n tr·ªçng'),
                                summary: responseText.substring(0, 200) + (responseText.length > 200 ? '...' : ''),
                                details: []
                            };
                        }
                    } catch (parseError) {
                        // Fallback parsing
                        return {
                            isValid: responseText.toLowerCase().includes('h·ª£p l·ªá') && !responseText.toLowerCase().includes('kh√¥ng h·ª£p l·ªá'),
                            hasWarning: responseText.toLowerCase().includes('c·∫ßn ki·ªÉm tra'),
                            summary: responseText.substring(0, 200) + (responseText.length > 200 ? '...' : ''),
                            details: []
                        };
                    }
                } else {
                    throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ Gemini');
                }
            } catch (error) {
                console.error('Gemini API Error:', error);
                throw error;
            }
        }

        // Initialize status update for facilities
        function updateFacilityStatus(cskcb) {
            const statusCell = document.getElementById(`status-${cskcb}`);
            if (statusCell && analysisResults[cskcb]) {
                const results = Object.values(analysisResults[cskcb]);
                const analyzed = results.length;
                const total = rawDataByCSKCB[cskcb].length;
                const valid = results.filter(r => r.isValid).length;
                
                if (analyzed === total) {
                    statusCell.innerHTML = `<span class="badge bg-success">Ho√†n th√†nh (${valid}/${total})</span>`;
                } else if (analyzed > 0) {
                    statusCell.innerHTML = `<span class="badge bg-warning">ƒêang ph√¢n t√≠ch (${analyzed}/${total})</span>`;
                } else {
                    statusCell.innerHTML = `<span class="badge bg-secondary">Ch∆∞a ph√¢n t√≠ch</span>`;
                }
            }
        }

        // Enhanced data validation
        function validateMedicalData(rowData) {
            const issues = [];
            
            if (!rowData['MA_BN']) issues.push('Thi·∫øu m√£ b·ªánh nh√¢n');
            if (!rowData['TEN_CP']) issues.push('Thi·∫øu t√™n ch·∫ø ph·∫©m');
            if (!rowData['MA_BENH'] && !rowData['MA_BENHKHAC']) issues.push('Thi·∫øu m√£ b·ªánh');
            
            return {
                isValid: issues.length === 0,
                issues: issues
            };
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'a':
                        e.preventDefault();
                        // Analyze all visible records
                        const activeAnalyzeAllBtn = document.querySelector('[id^="analyze-all-"]:not([disabled])');
                        if (activeAnalyzeAllBtn) activeAnalyzeAllBtn.click();
                        break;
                    case 'e':
                        e.preventDefault();
                        // Export results
                        const activeExportBtn = document.querySelector('[id^="export-results-"]');
                        if (activeExportBtn) activeExportBtn.click();
                        break;
                }
            }
        });

        // Add tooltip for better UX
        function addTooltips() {
            const tooltips = {
                'MA_BENH': 'M√£ b·ªánh ch√≠nh theo ph√¢n lo·∫°i ICD-10',
                'MA_BENHKHAC': 'C√°c m√£ b·ªánh k√®m theo, ph√¢n c√°ch b·∫±ng d·∫•u ;',
                'TEN_CP': 'T√™n ch·∫ø ph·∫©m/thu·ªëc ƒë∆∞·ª£c k√™ ƒë∆°n'
            };
            
            Object.keys(tooltips).forEach(key => {
                const elements = document.querySelectorAll(`th:contains("${key}")`);
                elements.forEach(el => {
                    el.title = tooltips[key];
                    el.style.cursor = 'help';
                });
            });
        }

        // Performance optimization for large datasets
        function optimizeTableRendering(cskcb) {
            const tbody = document.getElementById(`tbody-${cskcb}`);
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;
            
            rows.forEach((row, index) => {
                if (row.style.display !== 'none') {
                    visibleCount++;
                    if (visibleCount > 100) {
                        row.style.display = 'none';
                        // Add "show more" functionality if needed
                    }
                }
            });
        }

        // Auto-save analysis progress
        function saveProgress() {
            const progress = {
                timestamp: Date.now(),
                analysisResults: analysisResults,
                totalAnalyzed: Object.values(analysisResults).reduce((sum, facility) => sum + Object.keys(facility).length, 0)
            };
            sessionStorage.setItem('analysis-progress', JSON.stringify(progress));
        }

        function loadProgress() {
            const saved = sessionStorage.getItem('analysis-progress');
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    // Only load if less than 1 hour old
                    if (Date.now() - progress.timestamp < 3600000) {
                        analysisResults = progress.analysisResults || {};
                        return true;
                    }
                } catch (e) {
                    console.warn('Could not load saved progress:', e);
                }
            }
            return false;
        }

        // Initialize progress loading
        window.addEventListener('load', function() {
            loadProgress();
        });

        // Save progress periodically
        setInterval(saveProgress, 30000); // Every 30 seconds
    </script>
</body>
</html>
